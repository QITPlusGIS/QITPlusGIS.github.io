import{dH as A,u as R}from"./uuid-De2V3pkO.js";import{o as D}from"./FeatureContainer-BV5r4dtJ.js";import{r as O,i as E,M as C,f as L,h as N}from"./mat3-Riwg5JNu.js";import{e as c}from"./mat3f32-BPgNI_lm.js";import{t as S}from"./vec2f32-DJy8k_UQ.js";import{r as $}from"./vec3f32-CYGJTZYG.js";import{L as I}from"./normalizeUtils-CHaYFzrc.js";import{i as T}from"./Container-DX7KQTHt.js";import{e as w}from"./color-cT1-Ge3_.js";import{h as _}from"./FramebufferObject-BKEPrhyG.js";import{R as m,E as F,C as v,F as p,O as P}from"./enums-BFYfP9qy.js";import{f as H}from"./ProgramTemplate-CzjMKiq1.js";const U=Math.PI/180,k=4;class W extends T{constructor(t){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=c(),this._localOrigin={x:0,y:0},this._getBounds=t}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=A(this._program)}doRender(t){const{context:e}=t,r=this._getBounds();if(r.length<1)return;this._createShaderProgram(e),this._updateMatricesAndLocalOrigin(t),this._updateBufferData(e,r),e.setBlendingEnabled(!0),e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),e.setStencilTestEnabled(!1),e.setBlendFunction(m.ONE,m.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0);const a=this._program;e.bindVAO(this._vao),e.useProgram(a),a.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),e.gl.lineWidth(1),e.drawElements(F.LINES,8*r.length,v.UNSIGNED_INT,0),e.bindVAO()}_createTransforms(){return{dvs:c()}}_createShaderProgram(t){if(this._program)return;const e=`precision highp float;
        uniform mat3 u_dvsMat3;

        attribute vec2 a_position;

        void main() {
          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);
          gl_Position = vec4(pos.xy, 0.0, 1.0);
        }`,r=`precision mediump float;
      void main() {
        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);
      }`;this._program=t.programCache.acquire(e,r,g().attributes)}_updateMatricesAndLocalOrigin(t){const{state:e}=t,{displayMat3:r,size:a,resolution:u,pixelRatio:o,rotation:n,viewpoint:i}=e,h=U*n,{x:s,y}=i.targetGeometry,B=I(s,e.spatialReference);this._localOrigin.x=B,this._localOrigin.y=y;const f=o*a[0],d=o*a[1],b=u*f,M=u*d,l=O(this._dvsMat3);E(l,l,r),C(l,l,S(f/2,d/2)),L(l,l,$(a[0]/b,-d/M,1)),N(l,l,-h)}_updateBufferData(t,e){const{x:r,y:a}=this._localOrigin,u=2*k*e.length,o=new Float32Array(u),n=new Uint32Array(8*e.length);let i=0,h=0;for(const s of e)s&&(o[2*i]=s[0]-r,o[2*i+1]=s[1]-a,o[2*i+2]=s[0]-r,o[2*i+3]=s[3]-a,o[2*i+4]=s[2]-r,o[2*i+5]=s[3]-a,o[2*i+6]=s[2]-r,o[2*i+7]=s[1]-a,n[h]=i+0,n[h+1]=i+3,n[h+2]=i+3,n[h+3]=i+2,n[h+4]=i+2,n[h+5]=i+1,n[h+6]=i+1,n[h+7]=i+0,i+=4,h+=8);if(this._vertexBuffer?this._vertexBuffer.setData(o.buffer):this._vertexBuffer=_.createVertex(t,p.DYNAMIC_DRAW,o.buffer),this._indexBuffer?this._indexBuffer.setData(n):this._indexBuffer=_.createIndex(t,p.DYNAMIC_DRAW,n),!this._vao){const s=g();this._vao=new H(t,s.attributes,s.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const g=()=>w("bounds",{geometry:[{location:0,name:"a_position",count:2,type:v.FLOAT}]});let et=class extends D{constructor(t){super(t),this.checkHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=R(this._boundsRenderer)}enableRenderingBounds(t){this._boundsRenderer=new W(t),this.requestRender()}get hasHighlight(){return this.checkHighlight()}onTileData(t,e){t.patch(e),this.contains(t)||this.addChild(t),this.requestRender()}onTileError(t){t.clear(),this.contains(t)||this.addChild(t)}_renderChildren(t,e){for(const r of this.children)r.isReady&&r.hasData&&(r.commit(t),t.context.setStencilFunction(P.EQUAL,r.stencilRef,255),r.getDisplayList().replay(t,r,e))}};export{et as i};
