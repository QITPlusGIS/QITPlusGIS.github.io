import{A as B,a as w,y as k,c as j,C as Y,u as G,aS as z,eT as Q}from"./uuid-896b9aab.js";import{m as W,b as A}from"./vec2-d237980c.js";import{_ as X}from"./TileStore-a2c7e73d.js";import{e as D,l as H}from"./TileInfoView-2d740459.js";function J(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function U(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function Z(e,t,s,i,r,o,n){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=o,e[5]=n,e}function ee(e,t){const s=t[0],i=t[1],r=t[2],o=t[3],n=t[4],c=t[5];let a=s*o-i*r;return a?(a=1/a,e[0]=o*a,e[1]=-i*a,e[2]=-r*a,e[3]=s*a,e[4]=(r*c-o*n)*a,e[5]=(i*n-s*c)*a,e):null}function te(e){return e[0]*e[3]-e[1]*e[2]}function R(e,t,s){const i=t[0],r=t[1],o=t[2],n=t[3],c=t[4],a=t[5],h=s[0],l=s[1],u=s[2],d=s[3],y=s[4],_=s[5];return e[0]=i*h+o*l,e[1]=r*h+n*l,e[2]=i*u+o*d,e[3]=r*u+n*d,e[4]=i*y+o*_+c,e[5]=r*y+n*_+a,e}function se(e,t,s){const i=t[0],r=t[1],o=t[2],n=t[3],c=t[4],a=t[5],h=Math.sin(s),l=Math.cos(s);return e[0]=i*l+o*h,e[1]=r*l+n*h,e[2]=i*-h+o*l,e[3]=r*-h+n*l,e[4]=c,e[5]=a,e}function ie(e,t,s){const i=t[0],r=t[1],o=t[2],n=t[3],c=t[4],a=t[5],h=s[0],l=s[1];return e[0]=i*h,e[1]=r*h,e[2]=o*l,e[3]=n*l,e[4]=c,e[5]=a,e}function re(e,t,s){const i=t[0],r=t[1],o=t[2],n=t[3],c=t[4],a=t[5],h=s[0],l=s[1];return e[0]=i,e[1]=r,e[2]=o,e[3]=n,e[4]=i*h+o*l+c,e[5]=r*h+n*l+a,e}function oe(e,t){const s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=-s,e[3]=i,e[4]=0,e[5]=0,e}function ne(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e}function le(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e}function he(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}function ce(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+1)}function ae(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e}function E(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e}function ue(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e}function fe(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e}function de(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]}function ye(e,t){const s=e[0],i=e[1],r=e[2],o=e[3],n=e[4],c=e[5],a=t[0],h=t[1],l=t[2],u=t[3],d=t[4],y=t[5],_=B();return Math.abs(s-a)<=_*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-h)<=_*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(r-l)<=_*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(o-u)<=_*Math.max(1,Math.abs(o),Math.abs(u))&&Math.abs(n-d)<=_*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(c-y)<=_*Math.max(1,Math.abs(c),Math.abs(y))}const _e=R,pe=E;Object.freeze(Object.defineProperty({__proto__:null,add:ae,copy:J,determinant:te,equals:ye,exactEquals:de,frob:ce,fromRotation:oe,fromScaling:ne,fromTranslation:le,identity:U,invert:ee,mul:_e,multiply:R,multiplyScalar:ue,multiplyScalarAndAdd:fe,rotate:se,scale:ie,set:Z,str:he,sub:pe,subtract:E,translate:re},Symbol.toStringTag,{value:"Module"}));function me(e,t){return e.length=0,t.forEach(s=>e.push(s)),e}const C=new Set,S=[],P=new Map,N=[0,0];let v=class extends Y{constructor(e){super(e),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:e,process:t,strategy:s}=this;this._queue=new X({concurrency:e,process:(i,r)=>{const o=this._keyToItem.get(i);return t(o,{signal:r})},peeker:s==="scale-first"?i=>this._peekByScaleFirst(i):i=>this._peekByCenterFirst(i)})}destroy(){this.clear(),this._queue=G(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}abort(e){const t=typeof e=="string"?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}isOngoing(e){const t=typeof e=="string"?e:e.id;return this.has(t)&&this._queue.isOngoing(t)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const s=this._queue.push(t),i=()=>{this._keyToItem.delete(t)};return this._keyToItem.set(t,e),s.then(i,i),s}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(e){if(!this.state)return e.values().next().value;const t=this.tileInfoView;let s=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY;e.forEach(h=>{const l=this._keyToItem.get(h),u=this.tileInfoView.getTileScale(l.key);P.has(u)||(P.set(u,[]),s=Math.max(u,s),i=Math.min(u,i)),P.get(u).push(l.key),C.add(u)});let r=this.state.scale;P.has(r)||(me(S,C),S.sort((h,l)=>h-l),r=S.reduce((h,l)=>Math.abs(l-r)<Math.abs(h-r)?l:h,S[0])),r=Math.min(r,s),r=Math.max(r,i);const o=P.get(r),n=t.getClosestInfoForScale(r),c=n.getColumnForX(this.state.center[0]),a=n.getRowForY(this.state.center[1]);return o.sort((h,l)=>{const u=n.denormalizeCol(h.col,h.world),d=n.denormalizeCol(l.col,l.world);return Math.sqrt((c-u)*(c-u)+(a-h.row)*(a-h.row))-Math.sqrt((c-d)*(c-d)+(a-l.row)*(a-l.row))}),C.clear(),P.clear(),o[0].id}_peekByCenterFirst(e){if(!this.state)return e.values().next().value;const t=this.tileInfoView,s=this.state.center;let i,r=Number.POSITIVE_INFINITY;return e.forEach(o=>{const n=this._keyToItem.get(o);t.getTileCoords(N,n.key);const c=W(N,s);c<r&&(r=c,i=n.key)}),i.id}};w([k({constructOnly:!0})],v.prototype,"concurrency",void 0),w([k({constructOnly:!0})],v.prototype,"process",void 0),w([k()],v.prototype,"state",void 0),w([k({constructOnly:!0})],v.prototype,"strategy",void 0),w([k({constructOnly:!0})],v.prototype,"tileInfoView",void 0),v=w([j("esri.views.2d.tiling.TileQueue")],v);const Se=v;let ge=class{constructor(t,s,i){this.maxSize=t,this._tileInfoView=s,this._removedFunc=i,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(t){return this._tilePerId.has(t)}get(t){return this._tilePerId.get(t)}pop(t){const s=this._tilePerId.get(t);if(!s)return;const i=s.key.level,r=this._tileKeysPerLevel[i];O(this._tilePerId,t);for(let o=0;o<r.length;o++)if(r[o].id===t){r.splice(o,1);break}return s.visible=!0,s}add(t){t.visible=!1;const s=t.key,i=s.id;if(this._tilePerId.has(i))return;this._tilePerId.set(i,t);const r=s.level;this._tileKeysPerLevel[r]||(this._tileKeysPerLevel[r]=[]),this._tileKeysPerLevel[r].push(s)}prune(t,s,i){let r=this._tilePerId.size;if(r<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;r>this.maxSize&&o>=0;)o!==t&&(r=this._pruneAroundCenterTile(r,s,i,o)),o--;r>this.maxSize&&(r=this._pruneAroundCenterTile(r,s,i,t))}_pruneAroundCenterTile(t,s,i,r){const o=this._tileKeysPerLevel[r];if(!o||o.length===0)return t;const{size:n,origin:c}=this._tileInfoView.tileInfo,a=i*n[0],h=i*n[1],l=[0,0],u=[0,0];for(o.sort((d,y)=>(l[0]=c.x+a*(d.col+.5),l[1]=c.y-h*(d.row+.5),u[0]=c.x+a*(y.col+.5),u[1]=c.y-h*(y.row+.5),A(l,s)-A(u,s)));o.length>0;){const d=o.pop();if(this._removeTile(d.id),--t===this.maxSize)break}return t}_removeTile(t){const s=this._tilePerId.get(t);this._removedFunc&&s&&this._removedFunc(s),O(this._tilePerId,t)}};function O(e,t){e.delete(t)}const M=new D(0,0,0,0),g=new Map,T=[],q=[];let Ce=class{constructor(t){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,t.resampling!=null&&(this.resampling=t.resampling),t.cachePolicy&&(this.cachePolicy=t.cachePolicy),t.coveragePolicy&&(this.coveragePolicy=t.coveragePolicy),t.buffer!=null&&(this.buffer=t.buffer),t.cacheSize&&(this._tileCache=new ge(t.cacheSize,this.tileInfoView,s=>{this.releaseTile(s)}))}destroy(){this.tileIndex.clear()}update(t){var V,F;const{resampling:s,tileIndex:i}=this,{scale:r,center:o,resolution:n}=t.state,{minScale:c,maxScale:a}=this.tileInfoView,h=!t.stationary&&r>this._previousScale;if(this._previousScale=r,!s&&(r>c||r<a))return this.tiles.length=0,void this.clear();const l=this.tileInfoView.getTileCoverage(t.state,this.buffer,this.resampling,this.coveragePolicy);if(!l)return this.tiles.length=0,void this.clear();const{spans:u,lodInfo:d}=l,{level:y}=d;this.tiles.length=0,i.forEach(f=>f.visible=!0);let _=0,$=0;if(u.length>0)for(const{row:f,colFrom:b,colTo:x}of u)for(let I=b;I<=x;I++){_++;const p=M.set(y,f,d.normalizeCol(I),d.getWorldForColumn(I)).id;let m=i.get(p);if(m)m.isReady?(g.set(p,m),$++):h||this._addParentTile(p,g);else{if((V=this._tileCache)!=null&&V.has(p)){if(m=this._tileCache.pop(p),this.tileIndex.set(p,m),m.isReady){g.set(p,m),$++;continue}}else m=this.acquireTile(M),this.tileIndex.set(p,m);h||this._addParentTile(p,g)}}const L=$===_;for(const[f,b]of i){if(g.has(f))continue;M.set(f);const x=this.tileInfoView.intersects(l,M),I=this.cachePolicy==="purge"?M.level!==y:M.level>y;!x||!h&&L?!I&&x||T.push(b):b.isReady?I&&this.cachePolicy==="purge"&&this._hasReadyAncestor(M,y)?T.push(b):q.push(b):I&&T.push(b)}for(const f of q)f.isReady&&g.set(f.key.id,f);for(const f of T)this._tileCache?this._tileCache.add(f):this.releaseTile(f),i.delete(f.key.id);for(const f of g.values())this.tiles.push(f);for(const f of i.values())g.has(f.key.id)||(f.visible=!1);(F=this._tileCache)==null||F.prune(y,o,n),H.pool.release(l),q.length=0,T.length=0,g.clear()}clear(){const{tileIndex:t}=this;for(const s of t.values())this.releaseTile(s);t.clear()}refresh(t){var s;for(const i of this.tileIndex.values())this.tiles.includes(i)?t(i):T.push(i);for(const i of T)this.releaseTile(i),this.tileIndex.delete(i.key.id);(s=this._tileCache)==null||s.clear()}updateCacheSize(t){this._tileCache&&(this._tileCache.maxSize=t)}_addParentTile(t,s){var o;let i=t,r=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(r=this.tileIndex.get(i),r==null?void 0:r.isReady){s.has(r.key.id)||s.set(r.key.id,r);break}}else if((o=this._tileCache)!=null&&o.has(i)&&(r=this._tileCache.pop(i),this.tileIndex.set(i,r),r==null?void 0:r.isReady)){s.has(r.key.id)||s.set(r.key.id,r);break}}_hasReadyAncestor(t,s){const i=z();this.tileInfoView.getTileBounds(i,t,!0);for(const r of this.tileIndex.values())if(r.isReady&&r.key.level>=s&&r.key.level<t.level){const o=z();if(this.tileInfoView.getTileBounds(o,r.key,!0),Q(o,i))return!0}return!1}};function Ie(){const e=new Float32Array(6);return e[0]=1,e[3]=1,e}function ve(e){const t=new Float32Array(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function be(e,t,s,i,r,o){const n=new Float32Array(6);return n[0]=e,n[1]=t,n[2]=s,n[3]=i,n[4]=r,n[5]=o,n}function Me(e,t){return new Float32Array(e,t,6)}function K(e,t,s,i){const r=t[i],o=t[i+1];e[i]=s[0]*r+s[2]*o+s[4],e[i+1]=s[1]*r+s[3]*o+s[5]}function Te(e,t,s,i=0,r=0,o=2){const n=r||t.length/o;for(let c=i;c<n;c++)K(e,t,s,c*o)}Object.freeze(Object.defineProperty({__proto__:null,clone:ve,create:Ie,createView:Me,fromValues:be,transform:K,transformMany:Te},Symbol.toStringTag,{value:"Module"}));export{ne as M,U as a,Te as b,ie as c,ee as d,se as e,le as f,oe as h,re as i,Ie as n,R as o,Ce as r,Z as s,Se as y};
