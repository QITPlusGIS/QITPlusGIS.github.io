import{eE as f,eF as A,eG as _,eH as R,eI as v,eJ as D,eK as O,au as E,eL as C,eM as L,eN as N,eO as I,eP as p,D as S,eQ as $}from"./index-7a11ac30.js";import{o as F}from"./FeatureContainer-67dc4e78.js";import{r as P}from"./vec3f32-2da9db36.js";import{i as T}from"./Container-f3918382.js";import{e as w}from"./color-9189cc93.js";import{h as m}from"./FramebufferObject-95f2a514.js";import{f as H}from"./ProgramTemplate-c6fe5bfb.js";const U=Math.PI/180,k=4;class W extends T{constructor(e){super(),this._program=null,this._vao=null,this._vertexBuffer=null,this._indexBuffer=null,this._dvsMat3=f(),this._localOrigin={x:0,y:0},this._getBounds=e}destroy(){this._vao&&(this._vao.dispose(),this._vao=null,this._vertexBuffer=null,this._indexBuffer=null),this._program=A(this._program)}doRender(e){const{context:t}=e,s=this._getBounds();if(s.length<1)return;this._createShaderProgram(t),this._updateMatricesAndLocalOrigin(e),this._updateBufferData(t,s),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!1),t.setStencilWriteMask(0),t.setStencilTestEnabled(!1),t.setBlendFunction(_.ONE,_.ONE_MINUS_SRC_ALPHA),t.setColorMask(!0,!0,!0,!0);const o=this._program;t.bindVAO(this._vao),t.useProgram(o),o.setUniformMatrix3fv("u_dvsMat3",this._dvsMat3),t.gl.lineWidth(1),t.drawElements(R.LINES,8*s.length,v.UNSIGNED_INT,0),t.bindVAO()}_createTransforms(){return{dvs:f()}}_createShaderProgram(e){if(this._program)return;const t=`precision highp float;
        uniform mat3 u_dvsMat3;

        attribute vec2 a_position;

        void main() {
          mediump vec3 pos = u_dvsMat3 * vec3(a_position, 1.0);
          gl_Position = vec4(pos.xy, 0.0, 1.0);
        }`,s=`precision mediump float;
      void main() {
        gl_FragColor = vec4(0.75, 0.0, 0.0, 0.75);
      }`;this._program=e.programCache.acquire(t,s,g().attributes)}_updateMatricesAndLocalOrigin(e){const{state:t}=e,{displayMat3:s,size:o,resolution:d,pixelRatio:a,rotation:n,viewpoint:i}=t,h=U*n,{x:r,y}=i.targetGeometry,B=D(r,t.spatialReference);this._localOrigin.x=B,this._localOrigin.y=y;const c=a*o[0],u=a*o[1],M=d*c,b=d*u,l=O(this._dvsMat3);E(l,l,s),C(l,l,L(c/2,u/2)),N(l,l,P(o[0]/M,-u/b,1)),I(l,l,-h)}_updateBufferData(e,t){const{x:s,y:o}=this._localOrigin,d=2*k*t.length,a=new Float32Array(d),n=new Uint32Array(8*t.length);let i=0,h=0;for(const r of t)r&&(a[2*i]=r[0]-s,a[2*i+1]=r[1]-o,a[2*i+2]=r[0]-s,a[2*i+3]=r[3]-o,a[2*i+4]=r[2]-s,a[2*i+5]=r[3]-o,a[2*i+6]=r[2]-s,a[2*i+7]=r[1]-o,n[h]=i+0,n[h+1]=i+3,n[h+2]=i+3,n[h+3]=i+2,n[h+4]=i+2,n[h+5]=i+1,n[h+6]=i+1,n[h+7]=i+0,i+=4,h+=8);if(this._vertexBuffer?this._vertexBuffer.setData(a.buffer):this._vertexBuffer=m.createVertex(e,p.DYNAMIC_DRAW,a.buffer),this._indexBuffer?this._indexBuffer.setData(n):this._indexBuffer=m.createIndex(e,p.DYNAMIC_DRAW,n),!this._vao){const r=g();this._vao=new H(e,r.attributes,r.bufferLayouts,{geometry:this._vertexBuffer},this._indexBuffer)}}}const g=()=>w("bounds",{geometry:[{location:0,name:"a_position",count:2,type:v.FLOAT}]});let J=class extends F{constructor(e){super(e),this.checkHighlight=()=>!0}destroy(){super.destroy(),this._boundsRenderer=S(this._boundsRenderer)}enableRenderingBounds(e){this._boundsRenderer=new W(e),this.requestRender()}get hasHighlight(){return this.checkHighlight()}onTileData(e,t){e.patch(t),this.contains(e)||this.addChild(e),this.requestRender()}onTileError(e){e.clear(),this.contains(e)||this.addChild(e)}_renderChildren(e,t){for(const s of this.children)s.isReady&&s.hasData&&(s.commit(e),e.context.setStencilFunction($.EQUAL,s.stencilRef,255),s.getDisplayList().replay(e,s,t))}};export{J as i};
