import{K as N,L as m,f9 as w,eu as F,dJ as T,b1 as z,F as P,db as R,ex as C,aT as j,S as O,fa as A,dl as L,a4 as V}from"./uuid-854440a9.js";import{s as D}from"./workers-bc069650.js";import{r as J}from"./signal-9aac29bc.js";import{f as K}from"./quickselect-149a6b43.js";import{a as Q}from"./QuantizationParameters-0cb320a2.js";import{e as E,l as W}from"./TileInfoView-c4c10e27.js";let X=class{constructor(){this._map=new Map,this._observable=new N}get size(){return m(this._observable),this._map.size}clear(){this._map.size>0&&(this._map.clear(),this._observable.notify())}delete(e){const s=this._map.delete(e);return s&&this._observable.notify(),s}entries(){return m(this._observable),this._map.entries()}forEach(e,s){m(this._observable),this._map.forEach((i,r)=>e.call(s,i,r,this),s)}get(e){return m(this._observable),this._map.get(e)}has(e){return m(this._observable),this._map.has(e)}keys(){return m(this._observable),this._map.keys()}set(e,s){return this._map.set(e,s),this._observable.notify(),this}values(){return m(this._observable),this._map.values()}[Symbol.iterator](){return m(this._observable),this._map[Symbol.iterator]()}get[Symbol.toStringTag](){return this._map[Symbol.toStringTag]}},G=class{constructor(e,s){this.item=e,this.controller=s,this.promise=null}};class le{constructor(e){this._schedule=null,this._task=null,this._deferreds=new X,this._controllers=new X,this._processingItems=new X,this._pausedSignal=J(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new D(e.peeker),this.process=e.process;const s=e.scheduler;e.priority&&s&&(this._task=s.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=w(this._schedule),this._task=w(this._task)}get updating(){var e;return!!((e=this._task)!=null&&e.updating)||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const s=this._controllers.get(e);s&&s.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(s=>e.push(s)),this._controllers.clear(),e.forEach(s=>s.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((s,i)=>e(i))}get(e){const s=this._deferreds.get(e);return s?s.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,s){const i=this.get(e);if(i)return i;const r=new AbortController;let h=null;s&&(h=F(s,()=>r.abort()));const n=()=>{const u=this._processingItems.get(e);u&&u.controller.abort(),o(),l.reject(C())},o=()=>{a.remove(),h!=null&&h.remove(),this._deferreds.delete(e),this._controllers.delete(e),this._queue.remove(e),this._processingItems.delete(e),this._scheduleNext()},a=T(r.signal,n),l=z();return this._deferreds.set(e,l),this._controllers.set(e,r),l.promise.then(o,o),this._queue.push(e),this._scheduleNext(),l.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const e=[];this._processingItems.forEach(s=>e.push(s)),this._processingItems.clear();for(const s of e)this._queue.push(s.item),s.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=P(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(s))}_processError(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(s))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let s;const i=new AbortController,r=new G(e,i);this._processingItems.set(e,r);try{s=this.process(e,i.signal)}catch(h){this._processError(r,h)}R(s)?(r.promise=s,s.then(h=>this._processResult(r,h),h=>this._processError(r,h))):this._processResult(r,s)}get test(){return{update:e=>this.runTask(e)}}}function b(t,e){if(!(this instanceof b))return new b(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function H(t,e,s){if(!s)return e.indexOf(t);for(var i=0;i<e.length;i++)if(s(t,e[i]))return i;return-1}function _(t,e){p(t,0,t.children.length,e,t)}function p(t,e,s,i,r){r||(r=f(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var h,n=e;n<s;n++)h=t.children[n],g(r,t.leaf?i(h):h);return r}function g(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function S(t,e){return t.minX-e.minX}function I(t,e){return t.minY-e.minY}function Y(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function x(t){return t.maxX-t.minX+(t.maxY-t.minY)}function U(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function Z(t,e){var s=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),r=Math.min(t.maxX,e.maxX),h=Math.min(t.maxY,e.maxY);return Math.max(0,r-s)*Math.max(0,h-i)}function B(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function v(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function f(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function k(t,e,s,i,r){for(var h,n=[e,s];n.length;)(s=n.pop())-(e=n.pop())<=i||(h=e+Math.ceil((s-e)/i/2)*i,K(t,h,e,s,r),n.push(e,h,h,s))}b.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,s=[],i=this.toBBox;if(!v(t,e))return s;for(var r,h,n,o,a=[];e;){for(r=0,h=e.children.length;r<h;r++)n=e.children[r],v(t,o=e.leaf?i(n):n)&&(e.leaf?s.push(n):B(t,o)?this._all(n,s):a.push(n));e=a.pop()}return s},collides:function(t){var e=this.data,s=this.toBBox;if(!v(t,e))return!1;for(var i,r,h,n,o=[];e;){for(i=0,r=e.children.length;i<r;i++)if(h=e.children[i],v(t,n=e.leaf?s(h):h)){if(e.leaf||B(t,n))return!0;o.push(h)}e=o.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,s=t.length;e<s;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var r=this.data;this.data=i,i=r}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=f([]),this},remove:function(t,e){if(!t)return this;for(var s,i,r,h,n=this.data,o=this.toBBox(t),a=[],l=[];n||a.length;){if(n||(n=a.pop(),i=a[a.length-1],s=l.pop(),h=!0),n.leaf&&(r=H(t,n.children,e))!==-1)return n.children.splice(r,1),a.push(n),this._condense(a),this;h||n.leaf||!B(n,o)?i?(s++,n=i.children[s],h=!1):n=null:(a.push(n),l.push(s),s=0,i=n,n=n.children[0])}return this},toBBox:function(t){return t},compareMinX:S,compareMinY:I,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var s=[];t;)t.leaf?e.push.apply(e,t.children):s.push.apply(s,t.children),t=s.pop();return e},_build:function(t,e,s,i){var r,h=s-e+1,n=this._maxEntries;if(h<=n)return _(r=f(t.slice(e,s+1)),this.toBBox),r;i||(i=Math.ceil(Math.log(h)/Math.log(n)),n=Math.ceil(h/Math.pow(n,i-1))),(r=f([])).leaf=!1,r.height=i;var o,a,l,u,c=Math.ceil(h/n),M=c*Math.ceil(Math.sqrt(n));for(k(t,e,s,M,this.compareMinX),o=e;o<=s;o+=M)for(k(t,o,l=Math.min(o+M-1,s),c,this.compareMinY),a=o;a<=l;a+=c)u=Math.min(a+c-1,l),r.children.push(this._build(t,a,u,i-1));return _(r,this.toBBox),r},_chooseSubtree:function(t,e,s,i){for(var r,h,n,o,a,l,u,c;i.push(e),!e.leaf&&i.length-1!==s;){for(u=c=1/0,r=0,h=e.children.length;r<h;r++)a=Y(n=e.children[r]),(l=U(t,n)-a)<c?(c=l,u=a<u?a:u,o=n):l===c&&a<u&&(u=a,o=n);e=o||e.children[0]}return e},_insert:function(t,e,s){var i=this.toBBox,r=s?t:i(t),h=[],n=this._chooseSubtree(r,this.data,e,h);for(n.children.push(t),g(n,r);e>=0&&h[e].children.length>this._maxEntries;)this._split(h,e),e--;this._adjustParentBBoxes(r,h,e)},_split:function(t,e){var s=t[e],i=s.children.length,r=this._minEntries;this._chooseSplitAxis(s,r,i);var h=this._chooseSplitIndex(s,r,i),n=f(s.children.splice(h,s.children.length-h));n.height=s.height,n.leaf=s.leaf,_(s,this.toBBox),_(n,this.toBBox),e?t[e-1].children.push(n):this._splitRoot(s,n)},_splitRoot:function(t,e){this.data=f([t,e]),this.data.height=t.height+1,this.data.leaf=!1,_(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,s){var i,r,h,n,o,a,l,u;for(a=l=1/0,i=e;i<=s-e;i++)n=Z(r=p(t,0,i,this.toBBox),h=p(t,i,s,this.toBBox)),o=Y(r)+Y(h),n<a?(a=n,u=i,l=o<l?o:l):n===a&&o<l&&(l=o,u=i);return u},_chooseSplitAxis:function(t,e,s){var i=t.leaf?this.compareMinX:S,r=t.leaf?this.compareMinY:I;this._allDistMargin(t,e,s,i)<this._allDistMargin(t,e,s,r)&&t.children.sort(i)},_allDistMargin:function(t,e,s,i){t.children.sort(i);var r,h,n=this.toBBox,o=p(t,0,e,n),a=p(t,s-e,s,n),l=x(o)+x(a);for(r=e;r<s-e;r++)h=t.children[r],g(o,t.leaf?n(h):h),l+=x(o);for(r=s-e-1;r>=e;r--)h=t.children[r],g(a,t.leaf?n(h):h),l+=x(a);return l},_adjustParentBBoxes:function(t,e,s){for(var i=s;i>=0;i--)g(e[i],t)},_condense:function(t){for(var e,s=t.length-1;s>=0;s--)t[s].children.length===0?s>0?(e=t[s-1].children).splice(e.indexOf(t[s]),1):this.clear():_(t[s],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};let $=class q{constructor(e,s){this.key=new E(0,0,0,0),this.bounds=j(),this.objectIds=new Set,this.key.set(s);const i=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.scale=i.scale,this.level=i.level}get id(){return this.key.id}get extent(){return O.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const e=this.key.getChildKeys(),s=A.acquire();for(let i=0;i<e.length;i++)s[i]=new q(this.tileInfoView,e[i]);return s}getQuantizationParameters(){return Q.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}};const d={added:[],removed:[]},y=new Set,ee=new E(0,0,0,0);let ue=class extends L{constructor(e){super(),this._tiles=new Map,this._index=b(9,V("esri-csp-restrictions")?s=>({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const s={added:[],removed:[]};for(const i of e.added)if(!this.has(i)){const r=new $(this.tileScheme,i);this._tiles.set(i,r),this._index.insert(r),s.added.push(r)}for(const i of e.removed)if(this.has(i)){const r=this.get(i);this._tiles.delete(i),this._index.remove(r),s.removed.push(r)}this.tiles.length=0,this._tiles.forEach(i=>this.tiles.push(i)),(s.added.length||s.removed.length)&&this.emit("update",s)}setViewState(e){const s=this.tileScheme.getTileCoverage(e,0);if(!s)return;const{spans:i,lodInfo:r}=s,{level:h}=r;if(i.length>0)for(const{row:n,colFrom:o,colTo:a}of i)for(let l=o;l<=a;l++){const u=ee.set(h,n,r.normalizeCol(l),r.getWorldForColumn(l)).id;if(y.add(u),!this.has(u)){const c=new $(this.tileScheme,u);this._tiles.set(u,c),this._index.insert(c),this.tiles.push(c),d.added.push(c)}}for(let n=this.tiles.length-1;n>=0;n--){const o=this.tiles[n];y.has(o.id)||(this._tiles.delete(o.id),this.tiles.splice(n,1),this._index.remove(o),d.removed.push(o))}(d.added.length||d.removed.length)&&this.emit("update",d),W.pool.release(s),y.clear(),d.added.length=0,d.removed.length=0}};export{le as _,ue as d,b as i};
