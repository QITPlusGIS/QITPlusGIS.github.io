import{a3 as j,Q as E,a as o,y as u,c as g,q as S,U as k,s as A,o as C,a5 as z}from"./uuid-De2V3pkO.js";import{x as $}from"./MD5-MtSiOt06.js";import{b as _,e as w,j as G,l as v}from"./SizeVariable-CEwBbtT1.js";let d=class extends j(E){constructor(s){super(s),this.expression=null,this.title=null,this.returnType=null}};o([u({type:String,json:{write:!0}})],d.prototype,"expression",void 0),o([u({type:String,json:{write:!0}})],d.prototype,"title",void 0),o([u({type:String,json:{write:!0}})],d.prototype,"returnType",void 0),d=o([g("esri.layers.support.ExpressionInfo")],d);const b=d;var x;let p=x=class extends E{constructor(e){super(e),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new x({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:S(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};o([u({type:Boolean,json:{write:!0}})],p.prototype,"isAutoGenerated",void 0),o([u({type:String,json:{write:!0}})],p.prototype,"name",void 0),o([u({type:String,json:{write:!0}})],p.prototype,"alias",void 0),o([u({type:String,json:{write:!0}})],p.prototype,"onStatisticField",void 0),o([u({type:b,json:{write:!0}})],p.prototype,"onStatisticExpression",void 0),o([u({type:String,json:{write:!0}})],p.prototype,"statisticType",void 0),p=x=o([g("esri.layers.support.AggregateField")],p);const h=p;var y;let m=y=class extends _{writeLevels(e,s,i){for(const r in e){const l=this.levels[r];return void(s.stops=l)}}clone(){return new y({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:w(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:w(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops?.map((e=>e.clone())),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions?.clone(),levels:S(this.levels)})}};o([u()],m.prototype,"levels",void 0),o([k("levels")],m.prototype,"writeLevels",null),m=y=o([g("esri.views.2d.engine.LevelDependentSizeVariable")],m);const R=A.getLogger("esri.views.2d.layers.support.clusterUtils");z.add("esri-cluster-arcade-enabled",!0);const L=z("esri-cluster-arcade-enabled"),Q=(e,s,i,r,l)=>{const t=s.clone();if(!D(t))return t;if(t.authoringInfo||(t.authoringInfo=new G),t.authoringInfo.isAutoGenerated=!0,"visualVariables"in t){const a=(t.visualVariables||[]).filter((n=>n.valueExpression!=="$view.scale")),T=V(a);a.forEach((n=>{n.type==="rotation"?n.field?n.field=c(e,n.field,"avg_angle","number"):n.valueExpression&&(n.field=f(e,n.valueExpression,"avg_angle","number"),n.valueExpression=null):n.normalizationField?(n.field=c(e,n.field,"avg_norm","number",n.normalizationField),n.normalizationField=null):n.field?n.field=c(e,n.field,"avg","number"):n.valueExpression&&(n.field=f(e,n.valueExpression,"avg","number"),n.valueExpression=null)})),T==null&&!U(a)&&l&&(a.push(F(i,r)),t.dynamicClusterSize=!0),t.visualVariables=a}switch(t.type){case"simple":break;case"pie-chart":for(const a of t.attributes)a.field?a.field=c(e,a.field,"sum","number"):a.valueExpression&&(a.field=f(e,a.valueExpression,"sum","number"),a.valueExpression=null);break;case"unique-value":t.field?t.field=c(e,t.field,"mode","string"):t.valueExpression&&(t.field=f(e,t.valueExpression,"mode","string"),t.valueExpression=null);break;case"class-breaks":t.normalizationField?(t.field=c(e,t.field,"avg_norm","number",t.normalizationField),t.normalizationField=null):t.field?t.field=c(e,t.field,"avg","number"):t.valueExpression&&(t.field=f(e,t.valueExpression,"avg","number"),t.valueExpression=null)}return t},V=e=>{for(const s of e)if(s.type==="size")return s;return null};function H(e,s,i){const r=e.clone();let l=!1;if("visualVariables"in r){const t=(r.visualVariables||[]).filter((a=>a.valueExpression!=="$view.scale"));V(t)==null&&(r.visualVariables||(r.visualVariables=[]),r.visualVariables.push(F(s,i)),r.dynamicClusterSize=!0,l=!0)}return{renderer:r,didInject:l}}const U=e=>{for(const s of e)if(s.field==="cluster_count")return!0;return!1},F=(e,s)=>{const i=[new v({value:0,size:0}),new v({value:1})];if(s==null)return new _({field:"cluster_count",stops:[...i,new v({value:2,size:0})]});const r=Object.keys(s).reduce(((l,t)=>({...l,[t]:[...i,new v({value:Math.max(2,s[t].minValue),size:e.clusterMinSize}),new v({value:Math.max(3,s[t].maxValue),size:e.clusterMaxSize})]})),{});return new m({field:"cluster_count",levels:r})},D=e=>{const s=i=>R.error(new C("Unsupported-renderer",i,{renderer:e}));if(!e)return!1;switch(e.type){case"unique-value":if(e.field2||e.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(e.normalizationField){const i=e.normalizationType;if(i!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${i}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${e.type}`),!1}if(!L){if("valueExpression"in e&&e.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in e&&e.visualVariables||[]).some((i=>!(!("valueExpression"in i)||!i.valueExpression))))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function I(e,s,i){switch(e){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const r=i,l="field",t=s.toLowerCase()+",norm:"+l+","+r.toLowerCase();return"cluster_avg_"+$(t)}}}function f(e,s,i,r){const l=$(s),t=i==="mode"?`cluster_type_${l}`:i==="sum"?`cluster_sum_${l}`:`cluster_avg_${l}`;return e.some((a=>a.name===t))||e.push(new h({name:t,isAutoGenerated:!0,onStatisticExpression:new b({expression:s,returnType:r}),statisticType:i})),t}function c(e,s,i,r,l){if(s==="cluster_count"||e.some((a=>a.name===s)))return s;const t=I(i,s,l);return e.some((a=>a.name===t))||(i==="avg_norm"?e.push(new h({name:t,isAutoGenerated:!0,onStatisticExpression:new b({expression:`$feature.${s} / $feature.${l}`,returnType:r}),statisticType:"avg"})):e.push(new h({name:t,isAutoGenerated:!0,onStatisticField:s,statisticType:i}))),t}export{h as a,D as b,Q as c,V as d,H as f,F as v};
