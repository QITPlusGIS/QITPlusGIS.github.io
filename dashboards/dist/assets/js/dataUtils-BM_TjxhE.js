import{Q as Ft,o as Vt,q as _t,s as Y,a as W,y as z,d4 as Dt,c as Rt,R as Lt,a5 as nt,W as Nt,fs as Ut,aT as Et,S as jt,ft as Gt}from"./uuid-De2V3pkO.js";let gt=class{constructor(e=null,n=null,r=null){this.minValue=e,this.maxValue=n,this.noDataValue=r}};const Ot=9999999e31,qt=2e-7,Wt={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34028234663852886e22,34028234663852886e22],f64:[-Number.MAX_VALUE,Number.MAX_VALUE],unknown:void 0,c64:void 0,c128:void 0};function ht(t){return Wt[t]??[-34028234663852886e22,34028234663852886e22]}function xe(t,e,n){if(t.depthCount&&t.depthCount>1)return;const{pixels:r,statistics:h,pixelType:s}=t,l=r[0].length,c=t.bandMasks??[],a=t.mask??new Uint8Array(l).fill(255),o=s==="f32"||s==="f64",i=ht(s);let u=!1;for(let p=0;p<r.length;p++){const f=typeof e=="number"?e:e[p];if(f==null)continue;const d=h?.[p]?.minValue??i[0],m=h?.[p]?.maxValue??i[1];if(d>f+Number.EPSILON||m<f-Number.EPSILON)continue;const g=c[p]||a.slice(),y=r[p],A=n?.customFloatTolerance;if(o&&A!==0){let w=A;w||(w=Math.abs(f)>=Ot?qt*Math.abs(f):s==="f32"?2**-23:Number.EPSILON);for(let k=0;k<y.length;k++)g[k]&&Math.abs(y[k]-f)<w&&(y[k]=0,g[k]=0,a[k]=0,u=!0)}else for(let w=0;w<y.length;w++)g[w]&&y[w]===f&&(y[w]=0,g[w]=0,a[w]=0,u=!0);c[p]=g}u&&(t.bandMasks=t.bandMasks||t.pixels.length>1?c:null,t.mask=a),u&&"updateStatistics"in t&&t.updateStatistics()}var Z;let G=Z=class extends Ft{static createEmptyBand(t,e){return new(Z.getPixelArrayConstructor(t))(e)}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){return this.pixels?.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Vt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new gt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map((n=>this._calculateBandStatistics(n,this.mask)));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=ht(t),r=this.pixels,h=this.width*this.height,s=r.length;let l,c,a;const o=[];for(let i=0;i<s;i++){a=Z.createEmptyBand(t,h),l=r[i];for(let u=0;u<h;u++)c=l[u],a[u]=c>n?n:c<e?e:c;o.push(a)}this.pixels=o,this.pixelType=t}extractBands(t){const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const r=e.length,h=t.some((u=>u>=e.length)),s=r===t.length&&!t.some(((u,p)=>u!==p));if(h||s)return this;const l=this.bandMasks?.length===r?t.map((u=>this.bandMasks[u])):void 0;let{mask:c,validPixelCount:a}=this;const{width:o,height:i}=this;if(l){if(l.length===1)c=l[0];else{const u=o*i;c=new Uint8Array(u).fill(255);for(let p=0;p<l.length;p++){const f=l[p];for(let d=0;d<u;d++)f[d]||(c[d]=0)}}a=c.filter((u=>!!u)).length}return new Z({pixelType:this.pixelType,width:o,height:i,mask:c,bandMasks:l,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map((u=>e[u])),statistics:n&&t.map((u=>n[u]))})}clone(){const t=new Z({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(this.mask instanceof Uint8Array?t.mask=new Uint8Array(this.mask):t.mask=this.mask.slice(0)),this.bandMasks&&(t.bandMasks=this.bandMasks.map((r=>new Uint8Array(r))));const n=Z.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const r=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=r?this.pixels[e].slice(0,this.pixels[e].length):new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=_t(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:r,pixels:h}=this;if(!t||!h?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let s,l,c,a;s=l=c=h[0],h.length>=3?(l=h[1],c=h[2]):h.length===2&&(l=h[1]);const o=new Uint32Array(t),i=this.width*this.height;if(s.length===i)if(e!=null&&e.length===i)if(n)for(a=0;a<i;a++){const u=e[a];if(u){const p=u/255;o[a]=r?u<<24|c[a]*p<<16|l[a]*p<<8|s[a]*p:u<<24|c[a]<<16|l[a]<<8|s[a]}}else for(a=0;a<i;a++)e[a]&&(o[a]=255<<24|c[a]<<16|l[a]<<8|s[a]);else for(a=0;a<i;a++)o[a]=255<<24|c[a]<<16|l[a]<<8|s[a];else Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:r}=this;if(!t||!e?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const h=this.pixelType;let s=1,l=0,c=1;if(r&&r.length>0){for(const m of r)if(m.minValue!=null&&(l=Math.min(l,m.minValue)),m.maxValue!=null&&m.minValue!=null){const g=m.maxValue-m.minValue;c=Math.max(c,g)}s=255/c}else{let m=255;h==="s8"?(l=-128,m=127):h==="u16"?m=65535:h==="s16"?(l=-32768,m=32767):h==="u32"?m=4294967295:h==="s32"?(l=-2147483648,m=2147483647):h==="f32"?(l=-34e38,m=34e38):h==="f64"&&(l=-Number.MAX_VALUE,m=Number.MAX_VALUE),s=255/(m-l)}const a=new Uint32Array(t),o=this.width*this.height;let i,u,p,f,d;if(i=u=p=e[0],i.length!==o)return Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(u=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===o)for(f=0;f<o;f++)n[f]&&(a[f]=255<<24|(p[f]-l)*s<<16|(u[f]-l)*s<<8|(i[f]-l)*s);else for(f=0;f<o;f++)a[f]=255<<24|(p[f]-l)*s<<16|(u[f]-l)*s<<8|(i[f]-l)*s;else if(n!=null&&n.length===o)for(f=0;f<o;f++)d=(i[f]-l)*s,n[f]&&(a[f]=255<<24|d<<16|d<<8|d);else for(f=0;f<o;f++)d=(i[f]-l)*s,a[f]=255<<24|d<<16|d<<8|d}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!e?.length)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let r,h,s,l;r=h=s=e[0],e.length>=3?(h=e[1],s=e[2]):e.length===2&&(h=e[1]);const c=this.width*this.height;if(r.length!==c)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===c)for(l=0;l<c;l++)t[a++]=r[l],t[a++]=h[l],t[a++]=s[l],t[a++]=1&n[l];else for(l=0;l<c;l++)t[a++]=r[l],t[a++]=h[l],t[a++]=s[l],t[a++]=1}_calculateBandStatistics(t,e){let n=1/0,r=-1/0;const h=t.length;let s,l=0;if(e!=null)for(s=0;s<h;s++)e[s]&&(l=t[s],n=l<n?l:n,r=l>r?l:r);else for(s=0;s<h;s++)l=t[s],n=l<n?l:n,r=l>r?l:r;return new gt(n,r)}};W([z({json:{write:!0}})],G.prototype,"width",void 0),W([z({json:{write:!0}})],G.prototype,"height",void 0),W([z({json:{write:!0}})],G.prototype,"pixelType",void 0),W([Dt("pixelType")],G.prototype,"castPixelType",null),W([z({json:{write:!0}})],G.prototype,"validPixelCount",void 0),W([z({json:{write:!0}})],G.prototype,"mask",void 0),W([z({json:{write:!0}})],G.prototype,"maskIsAlpha",void 0),W([z({json:{write:!0}})],G.prototype,"pixels",void 0),W([z()],G.prototype,"premultiplyAlpha",void 0),W([z({json:{write:!0}})],G.prototype,"statistics",void 0),W([z({json:{write:!0}})],G.prototype,"depthCount",void 0),W([z({json:{write:!0}})],G.prototype,"noDataValues",void 0),W([z({json:{write:!0}})],G.prototype,"bandMasks",void 0),G=Z=W([Rt("esri.layers.support.PixelBlock")],G);const _=G;var xt,wt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(xt||(xt={})),(function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"})(wt||(wt={}));const we=6;function R(t){return t!=null&&t.declaredClass==="esri.layers.support.PixelBlock"&&t.pixels&&t.pixels.length>0}function ye(t){if(!t?.length||t.some((i=>!R(i))))return null;if(t.length===1)return t[0]?.clone()??null;const e=t,{width:n,height:r,pixelType:h}=e[0];if(e.some((i=>i.width!==n||i.height!==r)))return null;const s=e.map((({mask:i})=>i)).filter((i=>i!=null));let l=null;s.length&&(l=new Uint8Array(n*r),l.set(s[0]),s.length>1&&Tt(s.slice(1),l));const c=[];e.forEach((({pixels:i})=>c.push(...i)));const a=e.map((({statistics:i})=>i)).filter((i=>i?.length)),o=[];return a.forEach((i=>o.push(...i))),new _({pixelType:h,width:n,height:r,mask:l,pixels:c,statistics:o.length?o:null})}function ke(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort(((u,p)=>u[0]-p[0]));let r=0;n[0][0]<0&&(r=n[0][0]);const h=Math.max(256,n[n.length-1][0]-r+1),s=new Uint8Array(4*h),l=[];let c,a=0,o=0;const i=n[0].length===5;if(h>65536)return n.forEach((u=>{l[u[0]-r]=i?u.slice(1):u.slice(1).concat([255])})),{indexed2DColormap:l,offset:r,alphaSpecified:i};if(t.fillUnspecified)for(c=n[o],a=c[0]-r;a<h;a++)s[4*a]=c[1],s[4*a+1]=c[2],s[4*a+2]=c[3],s[4*a+3]=i?c[4]:255,a===c[0]-r&&(c=o===n.length-1?c:n[++o]);else for(a=0;a<n.length;a++)c=n[a],o=4*(c[0]-r),s[o]=c[1],s[o+1]=c[2],s[o+2]=c[3],s[o+3]=i?c[4]:255;return{indexedColormap:s,offset:r,alphaSpecified:i}}function Me(t,e){if(!R(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),r=n.pixels;let h=n.mask;const s=n.width*n.height;if(r.length!==1)return t;const{indexedColormap:l,indexed2DColormap:c,offset:a,alphaSpecified:o}=e;let i=0;const u=r[0],p=new Uint8Array(u.length),f=new Uint8Array(u.length),d=new Uint8Array(u.length);let m,g=0;if(l){const y=l.length-1;if(h!=null)for(i=0;i<s;i++)h[i]&&(g=4*(u[i]-a),g<a||g>y?h[i]=0:(p[i]=l[g],f[i]=l[g+1],d[i]=l[g+2],h[i]=l[g+3]));else{for(h=new Uint8Array(s),i=0;i<s;i++)g=4*(u[i]-a),g<a||g>y?h[i]=0:(p[i]=l[g],f[i]=l[g+1],d[i]=l[g+2],h[i]=l[g+3]);n.mask=h}}else if(c)if(h!=null)for(i=0;i<s;i++)h[i]&&(m=c[u[i]],p[i]=m[0],f[i]=m[1],d[i]=m[2],h[i]=m[3]);else{for(h=new Uint8Array(s),i=0;i<s;i++)m=c[u[i]],p[i]=m[0],f[i]=m[1],d[i]=m[2],h[i]=m[3];n.mask=h}return n.pixels=[p,f,d],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=o,n}function Ae(t,e){if(!R(t))return null;const{pixels:n,mask:r}=t,h=n.length;let s=e.lut;const{offset:l}=e;s&&s[0].length===1&&(s=n.map((()=>s)));const c=[],a=e.outputPixelType||"u8";for(let i=0;i<h;i++){const u=Pt(n[i],r,s[i],l||0,a);c.push(u)}const o=new _({width:t.width,height:t.height,pixels:c,mask:r,pixelType:a});return o.updateStatistics(),o}function Pt(t,e,n,r,h){const s=t.length,l=_.createEmptyBand(h,s);if(e)for(let c=0;c<s;c++)e[c]&&(l[c]=n[t[c]-r]);else for(let c=0;c<s;c++)l[c]=n[t[c]-r];return l}function be(t,e){if(!R(t))return null;const n=t.clone(),{pixels:r}=n,h=n.width*n.height,s=e.length,l=Math.floor(s/2),c=e[Math.floor(l)],a=r[0];let o,i,u,p,f,d,m=!1;const g=new Uint8Array(h),y=new Uint8Array(h),A=new Uint8Array(h);let w=n.mask;const k=e[0].mappedColor.length===4;for(w||(w=new Uint8Array(h),w.fill(k?255:1),n.mask=w),f=0;f<h;f++)if(w[f]){for(o=a[f],m=!1,d=l,i=c,u=0,p=s-1;p-u>1;){if(o===i.value){m=!0;break}o>i.value?u=d:p=d,d=Math.floor((u+p)/2),i=e[Math.floor(d)]}m||(o===e[u].value?(i=e[u],m=!0):o===e[p].value?(i=e[p],m=!0):o<e[u].value?(m=!1,i=null):o>e[u].value&&(o<e[p].value?(i=e[u],m=!0):p===s-1?(m=!1,i=null):(i=e[p],m=!0))),m?(g[f]=i.mappedColor[0],y[f]=i.mappedColor[1],A[f]=i.mappedColor[2],w[f]=i.mappedColor[3]):g[f]=y[f]=A[f]=w[f]=0}return n.pixels=[g,y,A],n.mask=w,n.pixelType="u8",n.maskIsAlpha=k,n}function ve(t,e){if(!R(t))return null;const{width:n,height:r}=t,{inputRanges:h,outputValues:s,outputPixelType:l,noDataRanges:c,allowUnmatched:a,isLastInputRangeInclusive:o}=e,i=t.pixels[0],u=_.createEmptyBand(l,i.length),p=t.mask,f=new Uint8Array(n*r);p?f.set(p):f.fill(255);const d=t.pixelType.startsWith("f")?1e-6:0,m=h.map((k=>k-d));m[0]=h[0],m[m.length-1]=h[h.length-1]+(o?1e-6:0);const g=h.length/2,[y,A]=ht(l);for(let k=0;k<r;k++)for(let x=0;x<n;x++){const M=k*n+x;if(f[M]){const U=i[M];let b=!1;for(let T=g-1;T>=0;T--)if(U===m[2*T]||U>m[2*T]&&U<m[2*T+1]){u[M]=s[T],b=!0;break}b||(a?u[M]=U>A?A:U<y?y:U:f[M]=0)}}const w=c?.length;if(w)for(let k=0;k<r;k++)for(let x=0;x<n;x++){const M=k*n+x;if(!p||p[M]){const U=i[M];for(let b=0;b<w;b+=2)if(U>=c[b]&&U<=c[b+1]){u[M]=0,f[M]=0;break}}}return new _({width:n,height:r,pixelType:l,pixels:[u],mask:f})}function yt(t,e,n,r){const h=n!=null&&n.length>=2?new Set(n):null,s=n?.length===1?n[0]:null,l=!!e?.length;for(let c=0;c<t.length;c++)if(r[c]){const a=t[c];if(l){let o=!1;for(let i=0;i<e.length;i+=2)if(a>=e[i]&&a<=e[i+1]){o=!0;break}o||(r[c]=0)}r[c]&&(a===s||h?.has(a))&&(r[c]=0)}}function kt(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let h=!1;for(let s=0;s<t.length;s++)if(t[s][r]){h=!0;break}h||(e[r]=0)}}function Tt(t,e){const n=t[0].length;for(let r=0;r<n;r++)if(e[r]){let h=!1;for(let s=0;s<t.length;s++)if(t[s][r]===0){h=!0;break}h&&(e[r]=0)}}function Ue(t,e){if(!R(t))return null;const{width:n,height:r,pixels:h}=t,s=n*r,l=new Uint8Array(s);t.mask?l.set(t.mask):l.fill(255);const c=h.length,{includedRanges:a,noDataValues:o,outputPixelType:i,matchAll:u,lookups:p}=e;if(p){const f=[];for(let d=0;d<c;d++){const m=p[d],g=Pt(h[d],l,m.lut,m.offset||0,"u8");f.push(g)}f.length===1?l.set(f[0]):u?kt(f,l):Tt(f,l)}else if(u){const f=[];for(let d=0;d<c;d++){const m=new Uint8Array(s);m.set(l),yt(h[d],a?.slice(2*d,2*d+2),o?.[d],m),f.push(m)}f.length===1?l.set(f[0]):kt(f,l)}else for(let f=0;f<c;f++)yt(h[f],a?.slice(2*f,2*f+2),o?.[f],l);return new _({width:n,height:r,pixelType:i,pixels:h,mask:l})}function Pe(t){const{srcPixelType:e,inputRanges:n,outputValues:r,allowUnmatched:h,noDataRanges:s,isLastInputRangeInclusive:l,outputPixelType:c}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,o=e.includes("s")?-a/2:0,i=_.createEmptyBand(c,a),u=new Uint8Array(a);h&&u.fill(255);const[p,f]=ht(c);if(n?.length&&r?.length){const m=n.map((g=>g-1e-6));m[0]=n[0],l&&(m[m.length-1]=n[n.length-1]);for(let g=0;g<m.length;g++){const y=r[g]>f?f:r[g]<p?p:r[g],A=Math.ceil(m[2*g]-o),w=Math.floor(m[2*g+1]-o);for(let k=A;k<=w;k++)i[k]=y,u[k]=255}}if(s?.length)for(let d=0;d<s.length;d++){const m=Math.ceil(s[2*d]-o),g=Math.floor(s[2*d+1]-o);for(let y=m;y<=g;y++)u[y]=0}return{lut:i,offset:o,mask:u}}function Te(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const r=t.includes("16")?65536:256,h=t.includes("s")?-r/2:0,s=new Uint8Array(r);if(e)for(let l=0;l<e.length;l++){const c=Math.ceil(e[2*l]-h),a=Math.floor(e[2*l+1]-h);for(let o=c;o<=a;o++)s[o]=255}else s.fill(255);if(n)for(let l=0;l<n.length;l++)s[n[l]-h]=0;return{lut:s,offset:h}}function Xt(t,e,n,r,h,s,l,c){return{xmin:h<=n*t?0:h<n*t+t?h-n*t:t,ymin:s<=r*e?0:s<r*e+e?s-r*e:e,xmax:h+l<=n*t?0:h+l<n*t+t?h+l-n*t:t,ymax:s+c<=r*e?0:s+c<r*e+e?s+c-r*e:e}}function $e(t,e){if(!t||t.length===0)return null;const n=t.find((d=>d.pixelBlock));if(n?.pixelBlock==null)return null;const r=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,h=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,s=.01*Math.min(r,h),l=t.sort(((d,m)=>Math.abs(d.extent.ymax-m.extent.ymax)>s?m.extent.ymax-d.extent.ymax:Math.abs(d.extent.xmin-m.extent.xmin)>s?d.extent.xmin-m.extent.xmin:0)),c=Math.min.apply(null,l.map((d=>d.extent.xmin))),a=Math.min.apply(null,l.map((d=>d.extent.ymin))),o=Math.max.apply(null,l.map((d=>d.extent.xmax))),i=Math.max.apply(null,l.map((d=>d.extent.ymax))),u={x:Math.round((e.xmin-c)/r),y:Math.round((i-e.ymax)/h)},p={width:Math.round((o-c)/r),height:Math.round((i-a)/h)},f={width:Math.round((e.xmax-e.xmin)/r),height:Math.round((e.ymax-e.ymin)/h)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==l.length||u.x<0||u.y<0||p.width<f.width||p.height<f.height?null:{extent:e,pixelBlock:zt(l.map((d=>d.pixelBlock)),p,{clipOffset:u,clipSize:f})}}function ut(t,e,n,r,h,s){const{width:l,height:c}=n.block,{x:a,y:o}=n.offset,{width:i,height:u}=n.mosaic,p=Xt(l,c,r,h,a,o,i,u);let f=0,d=0;if(s){const m=s.hasGCSSShiftTransform?360:s.halfWorldWidth??0,g=l*s.resolutionX,y=s.startX+r*g;y<m&&y+g>m?d=s.rightPadding:y>=m&&(f=s.leftMargin-s.rightPadding,d=0)}if(p.xmax-=d,typeof e!="number")for(let m=p.ymin;m<p.ymax;m++){const g=(h*c+m-o)*i+(r*l-a)+f,y=m*l;for(let A=p.xmin;A<p.xmax;A++)t[g+A]=e[y+A]}else for(let m=p.ymin;m<p.ymax;m++){const g=(h*c+m-o)*i+(r*l-a)+f;for(let y=p.xmin;y<p.xmax;y++)t[g+y]=e}}function zt(t,e,n={}){const{clipOffset:r,clipSize:h,alignmentInfo:s,blockWidths:l}=n;if(l)return Jt(t,e,{blockWidths:l});const c=t.find((P=>R(P)));if(c==null)return null;const a=h?h.width:e.width,o=h?h.height:e.height,i=c.width,u=c.height,p=e.width/i,f=e.height/u,d={offset:r||{x:0,y:0},mosaic:h||e,block:{width:i,height:u}},m=c.pixelType,g=_.getPixelArrayConstructor(m),y=c.pixels.length,A=[];let w,k;for(let P=0;P<y;P++){k=new g(a*o);for(let $=0;$<f;$++)for(let v=0;v<p;v++){const S=t[$*p+v];R(S)&&(w=S.pixels[P],ut(k,w,d,v,$,s))}A.push(k)}const x=t.some((P=>P==null||P.mask!=null&&P.mask.length>0)),M=t.some((P=>P?.bandMasks&&P.bandMasks.length>1)),U=x?new Uint8Array(a*o):void 0,b=M?[]:void 0;if(U){for(let P=0;P<f;P++)for(let $=0;$<p;$++){const v=t[P*p+$],S=v!=null?v.mask:null;ut(U,S??(v?255:0),d,$,P,s)}if(b)for(let P=0;P<y;P++){const $=new Uint8Array(a*o);for(let v=0;v<f;v++)for(let S=0;S<p;S++){const V=t[v*p+S],B=V?.bandMasks?.[P]??V?.mask;ut($,B??(V?255:0),d,S,v,s)}b.push($)}}const T=new _({width:a,height:o,pixels:A,pixelType:m,bandMasks:b,mask:U});return T.updateStatistics(),T}function Jt(t,e,n){const r=t.find((g=>g!=null));if(r==null)return null;const h=t.some((g=>g==null||!!g.mask)),{width:s,height:l}=e,c=h?new Uint8Array(s*l):null,{blockWidths:a}=n,o=[],i=r.getPlaneCount(),u=_.getPixelArrayConstructor(r.pixelType);if(h)for(let g=0,y=0;g<t.length;y+=a[g],g++){const A=t[g];if(!R(A))continue;const w=A.mask;for(let k=0;k<l;k++)for(let x=0;x<a[g];x++)c[k*s+x+y]=w==null?255:w[k*A.width+x]}const p=t.some((g=>g?.bandMasks&&g.bandMasks.length>1)),f=p?[]:void 0,d=s*l;for(let g=0;g<i;g++){const y=new u(d),A=p?new Uint8Array(d):void 0;for(let w=0,k=0;w<t.length;k+=a[w],w++){const x=t[w];if(!R(x))continue;const M=x.pixels[g];if(M!=null){for(let U=0;U<l;U++)for(let b=0;b<a[w];b++)y[U*s+b+k]=M[U*x.width+b];if(A){const U=x.bandMasks?.[g]??x.mask;for(let b=0;b<l;b++)for(let T=0;T<a[w];T++)A[b*s+T+k]=U?U[b*x.width+T]:255}}}o.push(y),f&&A&&f.push(A)}const m=new _({width:s,height:l,mask:c,bandMasks:f,pixels:o,pixelType:r.pixelType});return m.updateStatistics(),m}function Ie(t,e,n){if(!R(t))return null;const{width:r,height:h}=t,s=e.x,l=e.y,c=n.width+s,a=n.height+l;if(s<0||l<0||c>r||a>h||s===0&&l===0&&c===r&&a===h)return t;t.mask||(t.mask=new Uint8Array(r*h));const o=t.mask;for(let i=0;i<h;i++){const u=i*r;for(let p=0;p<r;p++)o[u+p]=i<l||i>=a||p<s||p>=c?0:1}return t.updateStatistics(),t}function Ht(t){if(!R(t))return null;const e=t.clone(),{width:n,height:r,pixels:h}=t,s=h[0],l=e.pixels[0],c=t.mask;for(let a=2;a<r-1;a++){const o=new Map;for(let u=a-2;u<a+2;u++)for(let p=0;p<4;p++){const f=u*n+p;lt(o,s[f],c?c[f]:1)}l[a*n]=Mt(o),l[a*n+1]=l[a*n+2]=l[a*n];let i=3;for(;i<n-1;i++){let u=(a-2)*n+i+1;lt(o,s[u],c?c[u]:1),u=(a-1)*n+i+1,lt(o,s[u],c?c[u]:1),u=a*n+i+1,lt(o,s[u],c?c[u]:1),u=(a+1)*n+i+1,lt(o,s[u],c?c[u]:1),u=(a-2)*n+i-3,rt(o,s[u],c?c[u]:1),u=(a-1)*n+i-3,rt(o,s[u],c?c[u]:1),u=a*n+i-3,rt(o,s[u],c?c[u]:1),u=(a+1)*n+i-3,rt(o,s[u],c?c[u]:1),l[a*n+i]=Mt(o)}l[a*n+i+1]=l[a*n+i]}for(let a=0;a<n;a++)l[a]=l[n+a]=l[2*n+a],l[(r-1)*n+a]=l[(r-2)*n+a];return e.updateStatistics(),e}function Mt(t){if(t.size===0)return 0;let e=0,n=-1,r=0;const h=t.keys();let s=h.next();for(;!s.done;)r=t.get(s.value),r>e&&(n=s.value,e=r),s=h.next();return n}function rt(t,e,n){if(n===0)return;const r=t.get(e);r===1?t.delete(e):t.set(e,r-1)}function lt(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function Kt(t,e,n){let{x:r,y:h}=e;const{width:s,height:l}=n;if(r===0&&h===0&&l===t.height&&s===t.width)return t;const{width:c,height:a}=t,o=Math.max(0,h),i=Math.max(0,r),u=Math.min(r+s,c),p=Math.min(h+l,a);if(u<0||p<0||!R(t))return null;r=Math.max(0,-r),h=Math.max(0,-h);const{pixels:f}=t,d=s*l,m=f.length,g=[];for(let k=0;k<m;k++){const x=f[k],M=_.createEmptyBand(t.pixelType,d);for(let U=o;U<p;U++){const b=U*c;let T=(U+h-o)*s+r;for(let P=i;P<u;P++)M[T++]=x[b+P]}g.push(M)}const y=new Uint8Array(d),A=t.mask;for(let k=o;k<p;k++){const x=k*c;let M=(k+h-o)*s+r;for(let U=i;U<u;U++)y[M++]=A?A[x+U]:1}const w=new _({width:n.width,height:n.height,pixelType:t.pixelType,pixels:g,mask:y});return w.updateStatistics(),w}function Qt(t,e=!0){if(!R(t))return null;const{pixels:n,width:r,height:h,mask:s,pixelType:l}=t,c=[],a=Math.round(r/2),o=Math.round(h/2),i=h-1,u=r-1;for(let f=0;f<n.length;f++){const d=n[f],m=_.createEmptyBand(l,a*o);let g=0;for(let y=0;y<h;y+=2)for(let A=0;A<r;A+=2){const w=d[y*r+A];if(e){const k=A===u?w:d[y*r+A+1],x=y===i?w:d[y*r+A+r],M=A===u?x:y===i?k:d[y*r+A+r+1];m[g++]=(w+k+x+M)/4}else m[g++]=w}c.push(m)}let p=null;if(s!=null){p=new Uint8Array(a*o);let f=0;for(let d=0;d<h;d+=2)for(let m=0;m<r;m+=2){const g=s[d*r+m];if(e){const y=m===u?g:s[d*r+m+1],A=d===i?g:s[d*r+m+r],w=m===u?A:d===i?y:s[d*r+m+r+1];p[f++]=g*y*A*w?1:0}else p[f++]=g}}return new _({width:a,height:o,pixelType:l,pixels:c,mask:p})}function Se(t,e,n){if(!R(t))return null;const{width:r,height:h}=e;let{width:s,height:l}=t;const c=new Map,a={x:0,y:0},o=n==null?1:1+n;let i=t;for(let u=0;u<o;u++){const p=Math.ceil(s/r),f=Math.ceil(l/h);for(let d=0;d<f;d++){a.y=d*h;for(let m=0;m<p;m++){a.x=m*r;const g=Kt(i,a,e);c.set(`${u}/${d}/${m}`,g)}}u<o-1&&(i=Qt(i)),s=Math.round(s/2),l=Math.round(l/2)}return c}function $t(t,e,n,r,h=0){const{width:s,height:l}=t,{width:c,height:a}=e,o=r.cols,i=r.rows,u=Math.ceil(c/o-.1/o),p=Math.ceil(a/i-.1/i);let f,d,m,g,y,A,w;const k=u*o,x=k*p*i,M=new Float32Array(x),U=new Float32Array(x),b=new Uint32Array(x),T=new Uint32Array(x);let P,$,v=0;for(let S=0;S<p;S++)for(let V=0;V<u;V++){f=12*(S*u+V),d=n[f],m=n[f+1],g=n[f+2],y=n[f+3],A=n[f+4],w=n[f+5];for(let B=0;B<i;B++){v=(S*i+B)*k+V*o,$=(B+.5)/i;for(let I=0;I<B;I++)P=(I+.5)/o,M[v+I]=(d*P+m*$+g)*s+h,U[v+I]=(y*P+A*$+w)*l+h,b[v+I]=Math.floor(M[v+I]),T[v+I]=Math.floor(U[v+I])}f+=6,d=n[f],m=n[f+1],g=n[f+2],y=n[f+3],A=n[f+4],w=n[f+5];for(let B=0;B<i;B++){v=(S*i+B)*k+V*o,$=(B+.5)/i;for(let I=B;I<o;I++)P=(I+.5)/o,M[v+I]=(d*P+m*$+g)*s+h,U[v+I]=(y*P+A*$+w)*l+h,b[v+I]=Math.floor(M[v+I]),T[v+I]=Math.floor(U[v+I])}}return{offsets_x:M,offsets_y:U,offsets_xi:b,offsets_yi:T,gridWidth:k}}function Be(t,e){const{coefficients:n,spacing:r}=e,{offsets_x:h,offsets_y:s,gridWidth:l}=$t(t,t,n,{rows:r[0],cols:r[1]}),{width:c,height:a}=t,o=new Float32Array(c*a),i=180/Math.PI;for(let u=0;u<a;u++)for(let p=0;p<c;p++){const f=u*l+p,d=u===0?f:f-l,m=u===a-1?f:f+l,g=h[d]-h[m],y=s[m]-s[d];if(isNaN(g)||isNaN(y))o[u*c+p]=90;else{let A=Math.atan2(y,g)*i;A=(360+A)%360,o[u*c+p]=A}}return o}function Ce(t,e,n,r,h="nearest"){if(!R(t))return null;h==="majority"&&(t=Ht(t));const{pixels:s,mask:l,bandMasks:c,pixelType:a}=t,o=t.width,i=t.height,u=_.getPixelArrayConstructor(a),p=s.length,{width:f,height:d}=e;let m=!1;for(let v=0;v<n.length;v+=3)n[v]===-1&&n[v+1]===-1&&n[v+2]===-1&&(m=!0);const{offsets_x:g,offsets_y:y,offsets_xi:A,offsets_yi:w,gridWidth:k}=$t({width:o,height:i},e,n,r,h==="majority"?.5:0);let x;const M=(v,S,V,B)=>{const I=v instanceof Float32Array||v instanceof Float64Array?0:.5;for(let C=0;C<d;C++){x=C*k;for(let F=0;F<f;F++){if(g[x]<0||y[x]<0)v[C*f+F]=0;else if(B)v[C*f+F]=S[A[x]+w[x]*o];else{const E=Math.floor(g[x]),q=Math.floor(y[x]),L=Math.ceil(g[x]),O=Math.ceil(y[x]),X=g[x]-E,H=y[x]-q;if(!V||V[E+q*o]&&V[L+q*o]&&V[E+O*o]&&V[L+O*o]){const et=(1-X)*S[E+q*o]+X*S[L+q*o],K=(1-X)*S[E+O*o]+X*S[L+O*o];v[C*f+F]=(1-H)*et+H*K+I}else v[C*f+F]=S[A[x]+w[x]*o]}x++}}},U=[];let b;const T=c?.length===p,P=[];for(let v=0;v<p;v++){if(T){const S=new Uint8Array(f*d);M(S,c[v],c[v],!0),P.push(S)}b=new u(f*d),M(b,s[v],T?c[v]:l,h==="nearest"||h==="majority"),U.push(b)}const $=new _({width:f,height:d,pixelType:a,pixels:U,bandMasks:T?P:void 0});if(l!=null)$.mask=new Uint8Array(f*d),M($.mask,l,l,!0);else if(m){$.mask=new Uint8Array(f*d);for(let v=0;v<f*d;v++)$.mask[v]=g[v]<0||y[v]<0?0:1}return $.updateStatistics(),$}const tt=new Map;tt.set("meter-per-second",1),tt.set("kilometer-per-hour",.277778),tt.set("knots",.514444),tt.set("feet-per-second",.3048),tt.set("mile-per-hour",.44704);const pt=180/Math.PI,dt=5,at=new Lt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function mt(t,e){return tt.get(t)/tt.get(e)||1}function It(t){return(450-t)%360}function St(t,e="geographic"){const[n,r]=t,h=Math.sqrt(n*n+r*r);let s=Math.atan2(r,n)*pt;return s=(360+s)%360,e==="geographic"&&(s=It(s)),[h,s]}function Yt(t,e="geographic"){let n=t[1];e==="geographic"&&(n=It(n)),n%=360;const r=t[0];return[r*Math.cos(n/pt),r*Math.sin(n/pt)]}function Fe(t,e,n,r="geographic"){if(!R(t)||n==null)return t;const h=e==="vector-magdir"?t.clone():At(t,e),s=h.pixels[1];for(let l=0;l<s.length;l++)s[l]=r==="geographic"?(s[l]+n[l]+270)%360:(s[l]+360-n[l])%360;return e==="vector-magdir"?h:At(h,"vector-magdir")}function At(t,e,n="geographic",r=1){if(!R(t))return t;const{pixels:h,width:s,height:l}=t,c=s*l,a=h[0],o=h[1],i=t.pixelType.startsWith("f")?t.pixelType:"f32",u=_.createEmptyBand(i,c),p=_.createEmptyBand(i,c);let f=0;for(let m=0;m<l;m++)for(let g=0;g<s;g++)e==="vector-uv"?([u[f],p[f]]=St([a[f],o[f]],n),u[f]*=r):([u[f],p[f]]=Yt([a[f],o[f]],n),u[f]*=r,p[f]*=r),f++;const d=new _({pixelType:i,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[u,p]});return d.updateStatistics(),d}function Ve(t,e,n=1){if(n===1||!R(t))return t;const r=t.clone(),{pixels:h,width:s,height:l}=r,c=h[0];h[1];let a=0;for(let o=0;o<l;o++)for(let i=0;i<s;i++)c[a]*=n,a++;return r.updateStatistics(),r}function _e(t,e,n,r,h){if(h==null||!h.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/r),height:Math.round(n/r),resolution:t.width/e};const s=h.xmin,l=h.ymax,c=(t.xmax-t.xmin)/e*r,a=(t.ymax-t.ymin)/n*r,o=(c+a)/2;return t.xmin=s+Math.floor((t.xmin-s)/c)*c,t.xmax=s+Math.ceil((t.xmax-s)/c)*c,t.ymin=l+Math.floor((t.ymin-l)/a)*a,t.ymax=l+Math.ceil((t.ymax-l)/a)*a,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/a),resolution:o}}const Zt=Bt(0,0,0);function Bt(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const h=r?-1:1,s=13*h,l=-7*h,c=-2*h,a=-16*h,o=21.75,[i,u]=j(0,e+s,n,o),[p,f]=j(t-5.5,e+l,n,o),[d,m]=j(t+5.5,e+l,n,o),[g,y]=j(t-1.5,e+c,n,o),[A,w]=j(t+1.5,e+c,n,o),[k,x]=j(t-1.5,e+a,n,o),[M,U]=j(t+1.5,e+a,n,o);return[i,u,p,f,g,y,A,w,d,m,k,x,M,U]}function te(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=10,h=n?-1:1,s=5*h,l=20*h,c=25*h,a=45,o=0,i=0,u=2,p=0,f=u*h,d=n?1:-1,m=r/2*d;let[g,y]=[o+m,i-l],[A,w]=[g+u*d,y],[k,x]=[A-p*d,w+f],[M,U]=[o-m,i-c],[b,T]=[M+p*d,U-f],P=Math.ceil(t/dt),$=Math.floor(P/10);P-=8*$;const v=[],S=[];for(let X=0;X<P/2;X++,$--){$<=0&&P%2==1&&X===(P-1)/2&&(M=o,b=M+p*d,U=(U+y)/2,T=U-f);const[H,et]=j(M,U,e,a);if($>0){const[K,it]=j(A,U,e,a),[st,D]=j(g,y,e,a);v.push(K),v.push(it),v.push(H),v.push(et),v.push(st),v.push(D)}else{const[K,it]=j(A,w,e,a),[st,D]=j(k,x,e,a),[N,ct]=j(b,T,e,a);S.push(H),S.push(et),S.push(N),S.push(ct),S.push(st),S.push(D),S.push(K),S.push(it)}U+=s,y+=s,w+=s,x+=s,T+=s}const[V,B]=j(o+m,i+l,e,a),I=(r/2+u)*d,[C,F]=j(o+I,i+l,e,a),[E,q]=j(o+m,i-c,e,a),[L,O]=j(o+I,i-c,e,a);return{pennants:v,barbs:S,shaft:[V,B,C,F,E,q,L,O]}}function j(t,e,n,r=1){const h=Math.sqrt(t*t+e*e)/r,s=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[h,(2*Math.PI+s-n)%(2*Math.PI)]}const ot=[0,1,3,6,10,16,21,27,33,40,47,55,63],ee=[0,.5,1,1.5,2],ne=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Q(t,e,n,r){const h=mt(r||"knots",n);let s;for(s=1;s<e.length;s++)if(s===e.length-1){if(t<e[s]*h)break}else if(t<=e[s]*h)break;return Math.min(s-1,e.length-2)}function ie(t,e,n,r,h){let s=0;switch(e){case"beaufort_kn":s=Q(t,ot,"knots",n);break;case"beaufort_km":s=Q(t,ot,"kilometer-per-hour",n);break;case"beaufort_ft":s=Q(t,ot,"feet-per-second",n);break;case"beaufort_m":s=Q(t,ot,"meter-per-second",n);break;case"classified_arrow":s=Q(t,h??[],r,n);break;case"ocean_current_m":s=Q(t,ee,"meter-per-second",n);break;case"ocean_current_kn":s=Q(t,ne,"knots",n)}return s}function se(t,e){const{style:n,inputUnit:r,outputUnit:h,breakValues:s}=e,l=at.fromJSON(r),c=at.fromJSON(h),a=42,o=15;let i=0,u=0;const{width:p,height:f,mask:d}=t,m=t.pixels[0],g=t.pixels[1],y=d!=null?d.filter((x=>x>0)).length:p*f,A=new Float32Array(y*a),w=new Uint32Array(o*y),k=e.invertDirection?Bt(0,0,0,!1):Zt;for(let x=0;x<f;x++)for(let M=0;M<p;M++){const U=x*p+M;if(!d||d[x*p+M]){const b=(g[U]+360)%360/180*Math.PI,T=ie(m[U],n,l,c,s);for(let $=0;$<k.length;$+=2)A[i++]=(M+.5)/p,A[i++]=(x+.5)/f,A[i++]=k[$],A[i++]=k[$+1]+b,A[i++]=T,A[i++]=m[U];const P=7*(i/a-1);w[u++]=P,w[u++]=P+1,w[u++]=P+2,w[u++]=P+0,w[u++]=P+4,w[u++]=P+3,w[u++]=P+0,w[u++]=P+2,w[u++]=P+3,w[u++]=P+2,w[u++]=P+5,w[u++]=P+3,w[u++]=P+5,w[u++]=P+6,w[u++]=P+3}}return{vertexData:A,indexData:w}}const ft=[];function le(t,e){if(ft.length===0)for(let f=0;f<30;f++)ft.push(te(5*f,0,!e.invertDirection));const n=mt(at.fromJSON(e.inputUnit),"knots"),{width:r,height:h,mask:s}=t,l=t.pixels[0],c=t.pixels[1],a=6,o=[],i=[];let u=0,p=0;for(let f=0;f<h;f++)for(let d=0;d<r;d++){const m=f*r+d,g=l[m]*n;if((!s||s[f*r+d])&&g>=dt){const y=(c[m]+360)%360/180*Math.PI,{pennants:A,barbs:w,shaft:k}=ft[Math.min(Math.floor(g/5),29)];if(A.length+w.length===0)continue;let x=o.length/a;const M=(d+.5)/r,U=(f+.5)/h;for(let b=0;b<A.length;b+=2)o[u++]=M,o[u++]=U,o[u++]=A[b],o[u++]=A[b+1]+y,o[u++]=0,o[u++]=g;for(let b=0;b<w.length;b+=2)o[u++]=M,o[u++]=U,o[u++]=w[b],o[u++]=w[b+1]+y,o[u++]=0,o[u++]=g;for(let b=0;b<k.length;b+=2)o[u++]=M,o[u++]=U,o[u++]=k[b],o[u++]=k[b+1]+y,o[u++]=0,o[u++]=g;for(let b=0;b<A.length/6;b++)i[p++]=x,i[p++]=x+1,i[p++]=x+2,x+=3;for(let b=0;b<w.length/8;b++)i[p++]=x,i[p++]=x+1,i[p++]=x+2,i[p++]=x+1,i[p++]=x+2,i[p++]=x+3,x+=4;i[p++]=x+0,i[p++]=x+1,i[p++]=x+2,i[p++]=x+1,i[p++]=x+3,i[p++]=x+2,x+=4}}return{vertexData:new Float32Array(o),indexData:new Uint32Array(i)}}function re(t,e){let r=0,h=0;const{width:s,height:l,mask:c}=t,a=t.pixels[0],o=[],i=[],u=mt(at.fromJSON(e.inputUnit),"knots"),p=e.style==="wind_speed"?dt:Number.MAX_VALUE;for(let f=0;f<l;f++)for(let d=0;d<s;d++){const m=a[f*s+d]*u;if((!c||c[f*s+d])&&m<p){for(let y=0;y<4;y++)o[r++]=(d+.5)/s,o[r++]=(f+.5)/l,o[r++]=y<2?-.5:.5,o[r++]=y%2==0?-.5:.5,o[r++]=0,o[r++]=m;const g=4*(r/24-1);i[h++]=g,i[h++]=g+1,i[h++]=g+2,i[h++]=g+1,i[h++]=g+2,i[h++]=g+3}}return{vertexData:new Float32Array(o),indexData:new Uint32Array(i)}}function De(t,e){return e.style==="simple_scalar"?re(t,e):e.style==="wind_speed"?le(t,e):se(t,e)}function Re(t,e,n,r=[0,0],h=.5){const{width:s,height:l,mask:c}=t,[a,o]=t.pixels,[i,u]=r,p=Math.round((s-i)/n),f=Math.round((l-u)/n),d=p*f,m=new Float32Array(d),g=new Float32Array(d),y=new Uint8Array(d);for(let w=0;w<f;w++)for(let k=0;k<p;k++){let x=0;const M=w*p+k,U=Math.max(0,w*n+u),b=Math.max(0,k*n+i),T=Math.min(l,U+n),P=Math.min(s,b+n);for(let $=U;$<T;$++)for(let v=b;v<P;v++){const S=$*s+v;if(!c||c[S]){x++;const V=[a[S],o[S]],[B,I]=V;m[M]+=B,g[M]+=I}}if(x>=(T-U)*(P-b)*(1-h)){y[M]=1;const[$,v]=St([m[M]/x,g[M]/x]);m[M]=$,g[M]=v}else y[M]=0,m[M]=0,g[M]=0}const A=new _({width:p,height:f,pixels:[m,g],mask:y});return A.updateStatistics(),A}const J=Y.getLogger("esri.views.2d.engine.flow.dataUtils"),oe=10;async function Le(t,e,n,r){const h=performance.now(),s=ae(e,n),l=performance.now(),c=ce(e,s,n.width,n.height),a=performance.now(),o=fe(c),i=performance.now(),u=t==="Streamlines"?pe(o,oe):de(o),p=performance.now();return nt("esri-2d-profiler")&&(J.info("I.1","_createFlowFieldFromData (ms)",Math.round(l-h)),J.info("I.2","_getStreamlines (ms)",Math.round(a-l)),J.info("I.3","createAnimatedLinesData (ms)",Math.round(i-a)),J.info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-i)),J.info("I.5","createFlowMesh (ms)",Math.round(p-h)),J.info("I.6","Mesh size (bytes)",u.vertexData.buffer.byteLength+u.indexData.buffer.byteLength)),await Promise.resolve(),Nt(r),u}function ae(t,e){const n=ue(e.data,e.width,e.height,t.smoothing);return t.interpolate?(r,h)=>{const s=Math.floor(r),l=Math.floor(h);if(s<0||s>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const c=r-s,a=h-l,o=s,i=l,u=s<e.width-1?s+1:s,p=l<e.height-1?l+1:l,f=n[2*(i*e.width+o)],d=n[2*(i*e.width+u)],m=n[2*(p*e.width+o)],g=n[2*(p*e.width+u)],y=n[2*(i*e.width+o)+1],A=n[2*(i*e.width+u)+1];return[(f*(1-a)+m*a)*(1-c)+(d*(1-a)+g*a)*c,(y*(1-a)+n[2*(p*e.width+o)+1]*a)*(1-c)+(A*(1-a)+n[2*(p*e.width+u)+1]*a)*c]}:(r,h)=>{const s=Math.round(r),l=Math.round(h);return s<0||s>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+s)],n[2*(l*e.width+s)+1]]}}function he(t,e,n,r,h,s,l,c,a){const o=[];let i=n,u=r,p=0,[f,d]=e(i,u);f*=t.velocityScale,d*=t.velocityScale;const m=Math.sqrt(f*f+d*d);let g,y;o.push({x:i,y:u,t:p,speed:m});for(let A=0;A<t.verticesPerLine;A++){let[w,k]=e(i,u);w*=t.velocityScale,k*=t.velocityScale;const x=Math.sqrt(w*w+k*k);if(x<t.minSpeedThreshold)return o;const M=w/x,U=k/x;if(i+=M*t.segmentLength,u+=U*t.segmentLength,p+=t.segmentLength/x,Math.acos(M*g+U*y)>t.maxTurnAngle)return o;if(t.collisions){const b=Math.round(i*a),T=Math.round(u*a);if(b<0||b>l-1||T<0||T>c-1)return o;const P=s[T*l+b];if(P!==-1&&P!==h)return o;s[T*l+b]=h}o.push({x:i,y:u,t:p,speed:x}),g=M,y=U}return o}function ce(t,e,n,r){const h=[],s=new Ut,l=1/Math.max(t.lineCollisionWidth,1),c=Math.round(n*l),a=Math.round(r*l),o=new Int32Array(c*a);for(let u=0;u<o.length;u++)o[u]=-1;const i=[];for(let u=0;u<r;u+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)i.push({x:p,y:u,sort:s.getFloat()});i.sort(((u,p)=>u.sort-p.sort));for(const{x:u,y:p}of i)if(s.getFloat()<t.density){const f=he(t,e,u,p,h.length,o,c,a,l);if(f.length<2)continue;h.push(f)}return h}function ue(t,e,n,r){if(r===0)return t;const h=Math.round(3*r),s=new Array(2*h+1);let l=0;for(let o=-h;o<=h;o++){const i=Math.exp(-o*o/(r*r));s[o+h]=i,l+=i}for(let o=-h;o<=h;o++)s[o+h]/=l;const c=new Float32Array(t.length);for(let o=0;o<n;o++)for(let i=0;i<e;i++){let u=0,p=0;for(let f=-h;f<=h;f++){if(i+f<0||i+f>=e)continue;const d=s[f+h];u+=d*t[2*(o*e+(i+f))],p+=d*t[2*(o*e+(i+f))+1]}c[2*(o*e+i)]=u,c[2*(o*e+i)+1]=p}const a=new Float32Array(t.length);for(let o=0;o<e;o++)for(let i=0;i<n;i++){let u=0,p=0;for(let f=-h;f<=h;f++){if(i+f<0||i+f>=n)continue;const d=s[f+h];u+=d*c[2*((i+f)*e+o)],p+=d*c[2*((i+f)*e+o)+1]}a[2*(i*e+o)]=u,a[2*(i*e+o)+1]=p}return a}function fe(t,e){const n=new Ut,r=t.reduce(((a,o)=>a+o.length),0),h=new Float32Array(4*r),s=new Array(t.length);let l=0,c=0;for(const a of t){const o=l;for(const i of a)h[4*l]=i.x,h[4*l+1]=i.y,h[4*l+2]=i.t,h[4*l+3]=i.speed,l++;s[c++]={startVertex:o,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:h,lineDescriptors:s}}function pe(t,e){const{lineVertices:r,lineDescriptors:h}=t;let s=0,l=0;for(const f of h)s+=2*f.numberOfVertices,l+=6*(f.numberOfVertices-1);const c=new Float32Array(s*9),a=new Uint32Array(l);let o=0,i=0;function u(){a[i++]=o-2,a[i++]=o,a[i++]=o-1,a[i++]=o,a[i++]=o+1,a[i++]=o-1}function p(f,d,m,g,y,A,w,k){const x=o*9;let M=0;c[x+M++]=f,c[x+M++]=d,c[x+M++]=1,c[x+M++]=m,c[x+M++]=A,c[x+M++]=w,c[x+M++]=g/2,c[x+M++]=y/2,c[x+M++]=k,o++,c[x+M++]=f,c[x+M++]=d,c[x+M++]=-1,c[x+M++]=m,c[x+M++]=A,c[x+M++]=w,c[x+M++]=-g/2,c[x+M++]=-y/2,c[x+M++]=k,o++}for(const f of h){const{totalTime:d,timeSeed:m}=f;let g=null,y=null,A=null,w=null,k=null,x=null;for(let M=0;M<f.numberOfVertices;M++){const U=r[4*(f.startVertex+M)],b=r[4*(f.startVertex+M)+1],T=r[4*(f.startVertex+M)+2],P=r[4*(f.startVertex+M)+3];let $=null,v=null,S=null,V=null;if(M>0){$=U-g,v=b-y;const B=Math.sqrt($*$+v*v);if($/=B,v/=B,M>1){let I=$+k,C=v+x;const F=Math.sqrt(I*I+C*C);I/=F,C/=F;const E=Math.min(1/(I*$+C*v),e);I*=E,C*=E,S=-C,V=I}else S=-v,V=$;S!==null&&V!==null&&(p(g,y,A,S,V,d,m,P),u())}g=U,y=b,A=T,k=$,x=v,w=P}p(g,y,A,-x,k,d,m,w)}return{vertexData:c,indexData:a}}function de(t){const{lineVertices:h,lineDescriptors:s}=t;let l=0,c=0;for(const B of s){const I=B.numberOfVertices-1;l+=4*I*2,c+=6*I*2}const a=new Float32Array(l*16),o=new Uint32Array(c);let i,u,p,f,d,m,g,y,A,w,k,x,M,U,b=0,T=0;function P(){o[T++]=b-8,o[T++]=b-7,o[T++]=b-6,o[T++]=b-7,o[T++]=b-5,o[T++]=b-6,o[T++]=b-4,o[T++]=b-3,o[T++]=b-2,o[T++]=b-3,o[T++]=b-1,o[T++]=b-2}function $(B,I,C,F,E,q,L,O,X,H,et,K,it,st){const D=b*16;let N=0;for(const ct of[1,2])for(const Ct of[1,2,3,4])a[D+N++]=B,a[D+N++]=I,a[D+N++]=C,a[D+N++]=F,a[D+N++]=L,a[D+N++]=O,a[D+N++]=X,a[D+N++]=H,a[D+N++]=ct,a[D+N++]=Ct,a[D+N++]=it,a[D+N++]=st,a[D+N++]=E/2,a[D+N++]=q/2,a[D+N++]=et/2,a[D+N++]=K/2,b++}function v(B,I){let C=A+k,F=w+x;const E=Math.sqrt(C*C+F*F);C/=E,F/=E;const q=A*C+w*F;C/=q,F/=q;let L=k+M,O=x+U;const X=Math.sqrt(L*L+O*O);L/=X,O/=X;const H=k*L+x*O;L/=H,O/=H,$(i,u,p,f,-F,C,d,m,g,y,-O,L,B,I),P()}function S(B,I,C,F,E,q){if(A=k,w=x,k=M,x=U,A==null&&w==null&&(A=k,w=x),d!=null&&m!=null){M=B-d,U=I-m;const L=Math.sqrt(M*M+U*U);M/=L,U/=L}A!=null&&w!=null&&v(E,q),i=d,u=m,p=g,f=y,d=B,m=I,g=C,y=F}function V(B,I){A=k,w=x,k=M,x=U,A==null&&w==null&&(A=k,w=x),A!=null&&w!=null&&v(B,I)}for(const B of s){i=null,u=null,p=null,f=null,d=null,m=null,g=null,y=null,A=null,w=null,k=null,x=null,M=null,U=null;const{totalTime:I,timeSeed:C}=B;for(let F=0;F<B.numberOfVertices;F++)S(h[4*(B.startVertex+F)],h[4*(B.startVertex+F)+1],h[4*(B.startVertex+F)+2],h[4*(B.startVertex+F)+3],I,C);V(I,C)}return{vertexData:a,indexData:o}}function bt(t,e){const n=e.pixels,{width:r,height:h}=e,s=new Float32Array(r*h*2),l=e.mask||new Uint8Array(r*h*2);if(e.mask||l.fill(255),t==="vector-uv")for(let c=0;c<r*h;c++)s[2*c]=n[0][c],s[2*c+1]=-n[1][c];else if(t==="vector-magdir")for(let c=0;c<r*h;c++){const a=n[0][c],o=Gt(n[1][c]),i=Math.cos(o-Math.PI/2),u=Math.sin(o-Math.PI/2);s[2*c]=i*a,s[2*c+1]=u*a}return{data:s,mask:l,width:r,height:h}}async function Ne(t,e,n,r,h,s){const l=performance.now(),c=Et(e.spatialReference);if(!c){const k=await vt(t,e,n,r,h,s);return nt("esri-2d-profiler")&&J.info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),nt("esri-2d-profiler")&&J.info("I.9","Number of parts",1),k}const[a,o]=c.valid,i=o-a,u=Math.ceil(e.width/i),p=e.width/u,f=Math.round(n/u);let d=e.xmin;const m=[],g=performance.now();for(let k=0;k<u;k++){const x=new jt({xmin:d,xmax:d+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});m.push(vt(t,x,f,r,h,s)),d+=p}const y=await Promise.all(m);nt("esri-2d-profiler")&&J.info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-g)),nt("esri-2d-profiler")&&J.info("I.9","Number of parts",y.length);const A={data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r};let w=0;for(const k of y){for(let x=0;x<k.height;x++)for(let M=0;M<k.width;M++)w+M>=n||(A.data[2*(x*n+w+M)]=k.data[2*(x*k.width+M)],A.data[2*(x*n+w+M)+1]=k.data[2*(x*k.width+M)+1],A.mask[x*n+w+M]=k.mask[x*k.width+M]);w+=k.width}return nt("esri-2d-profiler")&&J.info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),A}async function vt(t,e,n,r,h,s){const l={requestProjectedLocalDirections:!0,signal:s};if(h!=null&&(l.timeExtent=h),t.type==="imagery"){await t.load({signal:s});const o=t.rasterInfo.dataType,i=await t.fetchImage(e,n,r,l);return i?.pixelData?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:bt(o,i.pixelData.pixelBlock)}await t.load({signal:s});const c=t.rasterInfo.dataType,a=await t.fetchPixels(e,n,r,l);return a?.pixelBlock==null?{data:new Float32Array(n*r*2),mask:new Uint8Array(n*r),width:n,height:r}:bt(c,a.pixelBlock)}export{ve as A,Be as I,$e as M,Ce as R,Re as S,Ie as T,zt as U,Se as W,re as _,Fe as a,De as b,xe as c,at as d,mt as e,At as f,Ne as g,ht as h,Me as i,be as j,Ae as k,St as l,_e as m,ke as n,R as o,Ve as p,wt as q,ye as r,Le as s,xt as t,_ as u,we as v,Te as w,Ue as x,Pe as y,Pt as z};
