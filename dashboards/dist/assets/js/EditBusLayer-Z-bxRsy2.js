const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-DtOaE4Yo.js","./uuid-De2V3pkO.js","./index-OAJD89tD.js","./DeleteForwardEditsParameters-BQwaTlYn.js"])))=>i.map(i=>d[i]);
import{ct as S,a as H,q as h,dl as L,b1 as $,c as x}from"./uuid-De2V3pkO.js";import{_ as v}from"./index-OAJD89tD.js";const T=S(),k=new Map,E=new Map;async function q(e,s,d=!1){if(!e||!s)return!0;const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=E.get(r)?.entries();if(n){for(const[i,a]of n)if(a.name===s){const o=!a.stack?.hasForwardEdits();if(!o&&d){const[{deleteForwardEdits:u},{default:c}]=await Promise.all([v(()=>import("./deleteForwardEdits-DtOaE4Yo.js"),__vite__mapDeps([0,1,2]),import.meta.url),v(()=>import("./DeleteForwardEditsParameters-BQwaTlYn.js"),__vite__mapDeps([3,1,2]),import.meta.url)]);return u(r,i,new c({sessionId:T,moment:a.moment}))}return o}}return!0}function P(e,s){if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=E.get(d)?.entries();if(r){for(const[n,i]of r)if(i.name===s)return i.lockType==="edit"}return!1}const g=new L.EventEmitter;function U(e){return g.on("apply-edits",new WeakRef(e))}function D(e){return g.on("update-moment",new WeakRef(e))}function B(e,s,d=null,r=!1){const n=$();return r=s==null||r,g.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:d,mayReceiveServiceEdits:r,result:n.promise}),n}const j="esri.layers.mixins.EditBusLayer",w=Symbol(j);function C(e){return e!=null&&typeof e=="object"&&w in e}function m(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function F(e,s,d){const r=new URL(e).host,n=k.get(r),i=a=>!a||a===n;return i(s)&&i(d)||s===d}const z=e=>{var s;let d=class extends e{constructor(...r){super(...r),this[s]=!0,this._applyEditsHandler=n=>{const{serviceUrl:i,layerId:a,gdbVersion:o,mayReceiveServiceEdits:u,result:c}=n,b=i===this.url,p=a!=null&&this.layerId!=null&&a===this.layerId,A=m(this),V=m(this)&&F(i,o,this.gdbVersion);if(!b||A&&!V||!p&&!u)return;const R=c.then((t=>{if(p&&(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length))return this.emit("edits",h(t)),t;const I=t.editedFeatures?.find((({layerId:f})=>f===this.layerId));if(I){const{adds:f,updates:y,deletes:M}=I.editedFeatures,_={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:f?f.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],deletedFeatures:M?M.map((({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],updatedFeatures:y?y.map((({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]}))):[],editedFeatures:h(t.editedFeatures),exceededTransferLimit:!1,historicMoment:h(t.historicMoment)};return this.emit("edits",_),_}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:h(t.editedFeatures),exceededTransferLimit:!1,historicMoment:h(t.historicMoment)}})).then((t=>("historicMoment"in this&&this.historicMoment!==t.historicMoment&&P(i,o)&&(this.historicMoment=t.historicMoment),t)));this.emit("apply-edits",{result:R})},this._updateMomentHandler=n=>{const{serviceUrl:i,gdbVersion:a,moment:o}=n,u=i===this.url,c=m(this),b=m(this)&&F(i,a,this.gdbVersion),p=m(this)&&!F(i,this.gdbVersion,null);u&&c&&b&&p&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then((()=>{this.addHandles(U(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(D(this._updateMomentHandler))}),(()=>{}))}};return s=w,d=H([x(j)],d),d};export{z as F,P as a,B as c,C as p,T as r,q as s};
