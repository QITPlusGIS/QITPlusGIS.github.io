import{o as d,Z as F}from"./uuid-De2V3pkO.js";import{p as D}from"./arcgisLayerUrl-DMpJLG2u.js";import{r as k}from"./fetchService-DqRbh7i6.js";import{n as T,r as x,a as G,s as P,i as j,l as $,e as L,t as g}from"./portalLayers-DLhUBB7k.js";import{populateGroupLayer as E}from"./layersCreator-C9HQgp1P.js";import{a as C}from"./associatedFeatureServiceUtils-C3_2MfHS.js";import{e as O,l as R}from"./jsonContext-BvsZzvt8.js";import{s as J}from"./portalItemUtils-2ng-Kvae.js";import{t as N}from"./styleUtils-CfnOzvk7.js";import{t as Z}from"./requestPresets-CRFOpV8D.js";import"./index-OAJD89tD.js";import"./layerUtils-D8dZn4eh.js";import"./PortalItem-C8IOgJp9.js";async function ce(e,a){const r=e.instance.portalItem;if(r?.id)return await r.load(a),q(e),z(e,a)}function q(e){const a=e.instance.portalItem;if(!a?.type||!e.supportedTypes.includes(a.type))throw new d("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:e.supportedTypes.join(", ")})}async function z(e,a){const r=e.instance,t=r.portalItem;if(!t)return;const{url:o,title:s}=t,n=O(t);if(r.type==="group")return A(r,n,e);o&&r.read({url:o},n);const i=new L,l=await S(e,i,a);return l&&r.read(l,n),r.resourceReferences={portalItem:t,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),N(r,n)}async function A(e,a,r){const t=e.portalItem;if(!e.sourceIsPortalItem)return;const{title:o,type:s}=t;if(s==="Group Layer"){if(!J(t,"Map"))throw new d("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return B(e)}return e.read({title:o},a),H(e,r)}async function B(e){const a=e.portalItem,r=await a.fetchData("json");if(!r)return;const t=R(a);e.read(r,t),await E(e,r,{context:t}),e.resourceReferences={portalItem:a,paths:t.readResourcePaths??[]}}async function H(e,a){let r;const{portalItem:t}=e;if(!t)return;const o=t.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new d("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}const n=new L;let[i,l]=await Promise.all([r(),S(a,n)]),p=()=>i;if(o==="Feature Service"){l=t.url?await G(l,t.url,n):{};const m=T(l),h=P(l),c=[];if(m.length||h?.length){m.length&&c.push("SubtypeGroupLayer"),h?.length&&c.push("OrientedImageryLayer");const w=[];for(const u of c){const y=s[u];w.push(y())}const M=await Promise.all(w),b=new Map;c.forEach(((u,y)=>{b.set(u,M[y])})),p=u=>u.layerType?b.get(u.layerType)??i:i}const v=await X(t.url);return await f(e,p,l,v)}return o==="Scene Service"&&t.url&&(l=await j(t,l,n)),$(l)>0?await f(e,p,l):await K(e,p)}async function K(e,a){const{portalItem:r}=e;if(!r?.url)return;const t=await Z(r.url);t&&f(e,a,{layers:t.layers?.map(g),tables:t.tables?.map(g)})}async function f(e,a,r,t){let o=r.layers||[];const s=r.tables||[];if(e.portalItem?.type==="Feature Collection"?(o.forEach(((n,i)=>{n.id=i,n?.layerDefinition?.type==="Table"&&s.push(n)})),o=o.filter((n=>n?.layerDefinition?.type!=="Table"))):(o.reverse(),s.reverse()),o.forEach((n=>{const i=t?.(n);if(i||!t){const l=I(e,a(n),r,n,i);e.add(l)}})),s.length){const n=await C.FeatureLayer();s.forEach((i=>{const l=t?.(i);if(l||!t){const p=I(e,n,r,i,l);e.tables.add(p)}}))}}function I(e,a,r,t,o){const s=e.portalItem,n={portalItem:s.clone(),layerId:t.id};t.url!=null&&(n.url=t.url);const i=new a(n);if("sourceJSON"in i&&(i.sourceJSON=o),i.type!=="subtype-group"&&(i.sublayerTitleMode="service-name"),s.type==="Feature Collection"){const l={origin:"portal-item",portal:s.portal||F.getDefault()};i.read(t,l);const p=r.showLegend;p!=null&&i.read({showLegend:p},l)}return i}async function S(e,a,r){if(e.supportsData===!1)return;const t=e.instance,o=t.portalItem;if(!o)return;let s=null;try{s=await o.fetchData("json",r)}catch{}if(V(t)){let n=null;const i=await Q(o,s,a);if((s?.layers||s?.tables)&&i>0){if(t.layerId==null){const l=T(s);t.layerId=t.type==="subtype-group"?l?.[0]:x(s)}n=U(s,t),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return i>1&&"sublayerTitleMode"in t&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),n}return s}async function Q(e,a,r){if(a?.layers&&a?.tables)return $(a);const t=D(e.url);if(!t)return 1;const o=await r.fetchServiceMetadata(t.url.path).catch((()=>null));return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)}function U(e,a){const{layerId:r}=a,t=e.layers?.find((o=>o.id===r))||e.tables?.find((o=>o.id===r));return t&&W(t,a)?t:null}function V(e){return e.type!=="stream"&&"layerId"in e}function W(e,a){return!(a.type==="feature"&&"layerType"in e&&e.layerType==="SubtypeGroupLayer"||a.type==="subtype-group"&&!("layerType"in e))}async function X(e){const{layersJSON:a}=await k(e);if(!a)return null;const r=[...a.layers,...a.tables];return t=>r.find((o=>o.id===t.id))}export{ce as load};
