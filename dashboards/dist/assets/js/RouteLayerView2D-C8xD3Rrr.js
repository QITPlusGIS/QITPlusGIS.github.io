import{V as m,P as u,h,e as c,f as g,a as n,y as d,c as _}from"./uuid-De2V3pkO.js";import{l as w}from"./CollectionFlattener-BEJgaFwb.js";import{m as y,c as f,C as k,T as M,j as V,S as v,O as G}from"./Stop-RvV2ilMY.js";import{m as I,u as F}from"./LayerView-DVe-QqFJ.js";import{i as H}from"./GraphicContainer-B0JHZwYr.js";import{r as C}from"./GraphicsView2D-D913Qe__.js";import"./index-OAJD89tD.js";import"./scaleUtils-ApfxRMLk.js";import"./Container-DX7KQTHt.js";import"./mat3f32-BPgNI_lm.js";import"./parser-CQvYRaWk.js";import"./mat4f32-BYh1DbDV.js";import"./mat4-DR7ljCfE.js";import"./definitions-DYuD04dF.js";import"./enums-BFYfP9qy.js";import"./Texture-BUpON3bN.js";import"./capabilities-BeSycj8J.js";import"./map-BEES39Ai.js";import"./Basemap-DVlQKLRn.js";import"./loadAll-Cim39wYP.js";import"./PortalItem-C8IOgJp9.js";import"./writeUtils-993Cp9iz.js";import"./layerUtils-D8dZn4eh.js";import"./compilerUtils-BndV9QTL.js";import"./infoFor3D-CKoUGm1M.js";import"./basemapUtils-BPWzFCB8.js";import"./TablesMixin-BAh-Tdsn.js";import"./arcgisLayerUrl-DMpJLG2u.js";import"./Cyclical-bCBpTSsi.js";import"./workers-Dp_XhR59.js";import"./TileInfo-ybWiFFHA.js";import"./jsxFactory-CrT0-KGb.js";import"./UpdatingHandles-7vim6dHb.js";import"./signal-C4o35hpO.js";import"./GraphicsCollection-DbKTAY2Z.js";import"./ViewingMode-HRfKv6NR.js";import"./unitBezier-C3UyU2rI.js";import"./mat2df32-Y88URbH1.js";import"./vec2-C6Y96AwR.js";import"./TileStore-DTOce_SM.js";import"./quickselect-Dsa-MazW.js";import"./commonjsHelpers-DCkdB7M8.js";import"./QuantizationParameters-DrrRb5JH.js";import"./TileInfoView-CccucBWX.js";import"./vec2f64-BuJjW9A-.js";import"./normalizeUtils-CHaYFzrc.js";import"./normalizeUtilsCommon-vfKhPTnw.js";import"./mat3-Riwg5JNu.js";import"./vec2f32-DJy8k_UQ.js";import"./GoTo-BYKJE8LR.js";import"./color-cT1-Ge3_.js";import"./enums-lYQiQBYo.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./BaseGraphicContainer-DZjiSQFU.js";import"./FeatureContainer-BV5r4dtJ.js";import"./AttributeStoreView-DRtDspVQ.js";import"./TiledDisplayObject-BVLmQerJ.js";import"./diffUtils-B9GaWVUW.js";import"./labelingInfo-C5rI8Tdf.js";import"./LabelClass-5BgkMgGD.js";import"./labelUtils-Dph0uXsk.js";import"./defaultsJSON-CHAaurhX.js";import"./jsonUtils-CqYY9-3B.js";import"./WGLContainer-CCreaUuQ.js";import"./FramebufferObject-BKEPrhyG.js";import"./ProgramTemplate-CzjMKiq1.js";import"./GeometryUtils-CzofDDjY.js";import"./heatmapUtils-DncJMPvQ.js";import"./vec4f64-Jk3PXxMO.js";import"./StyleDefinition-C8U8LdH5.js";import"./config-BOD8--da.js";import"./earcut-BVL67bTw.js";import"./featureConversionUtils-BBvLZPS5.js";import"./OptimizedFeature-CuDeWVOV.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./visualVariablesUtils-CsTrhTSw.js";import"./ExpandedCIM-Dnfk4gBv.js";import"./BidiEngine-VcLDr8lR.js";import"./GeometryUtils-D08nBgDv.js";import"./utils-pl3RUk3K.js";import"./Rect-CUzevAry.js";import"./quantizationUtils-D3whBd2n.js";import"./floatRGBA-BJa16tCb.js";import"./clusterUtils-CBl3uOAm.js";import"./MD5-MtSiOt06.js";import"./SizeVariable-CEwBbtT1.js";import"./colorRamps-BC6MwlXc.js";import"./LegendOptions-FRTnoArL.js";import"./lengthUtils-C4EPlNSZ.js";import"./util-Co9CNf_x.js";import"./TileContainer-C6bCPGX3.js";import"./vec3f32-CYGJTZYG.js";import"./normalizeUtilsSync-BoYPclmC.js";import"./projectionSupport-DtScbnKU.js";import"./json-Wa8cmqdu.js";import"./Matcher-CavG8wnV.js";import"./tileUtils-B7X19rIS.js";import"./TurboLine-ADRWAXBV.js";import"./LRUCache-DMLtX-OB.js";import"./ComputedAttributeStorage-AKRlEkJh.js";import"./FieldsIndex-dTLkFgHd.js";import"./TimeOnly-LdAwpTO1.js";const U=["route-info","direction-line","direction-point","polygon-barrier","polyline-barrier","point-barrier","stop"],s={graphic:null,property:null,oldValue:null,newValue:null};function l(t){return t instanceof y||t instanceof f||t instanceof k||t instanceof M||t instanceof V||t instanceof v||t instanceof G}function $(t){return m.isCollection(t)&&t.length&&l(t.at(0))}function b(t){return Array.isArray(t)&&t.length>0&&l(t[0])}let p=class extends I(F){constructor(){super(...arguments),this._graphics=new m,this._highlightIds=new Map,this._networkFeatureMap=new Map,this._networkGraphicMap=new Map}get _routeItems(){return new w({getCollections:()=>this.layer==null||this.destroyed?[]:[this.layer.routeInfo!=null?new m([this.layer.routeInfo]):null,this.layer.directionLines,this.layer.directionPoints,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.pointBarriers,this.layer.stops]})}initialize(){this._updatingHandles.addOnCollectionChange((()=>this._routeItems),(t=>this._routeItemsChanged(t)),u)}destroy(){this._networkFeatureMap.clear(),this._networkGraphicMap.clear(),this._graphics.removeAll(),this._get("_routeItems")?.destroy()}attach(){this._createGraphicsView()}detach(){this._destroyGraphicsView()}async fetchPopupFeatures(t){return this._graphicsView.hitTest(t).filter((i=>!!i.popupTemplate))}highlight(t){let i;i=l(t)?[this._getNetworkFeatureUid(t)]:b(t)?t.map((e=>this._getNetworkFeatureUid(e))):$(t)?t.map((e=>this._getNetworkFeatureUid(e))).toArray():[t.uid];const r=i.filter(h);return r.length?(this._addHighlight(r),c((()=>this._removeHighlight(r)))):c()}async hitTest(t,i){if(this.suspended)return null;const r=this._graphicsView.hitTest(t).filter(h).map((o=>this._networkGraphicMap.get(o)));if(!r.length)return null;const{layer:e}=this;return r.reverse().map((o=>({type:"route",layer:e,mapPoint:t,networkFeature:o})))}isUpdating(){return this._graphicsView.updating}moveStart(){}moveEnd(){}update(t){this._graphicsView.processUpdate(t)}viewChange(){this._graphicsView.viewChange()}_addHighlight(t){for(const i of t)if(this._highlightIds.has(i)){const r=this._highlightIds.get(i);this._highlightIds.set(i,r+1)}else this._highlightIds.set(i,1);this._updateHighlight()}_createGraphic(t){const i=t.toGraphic();return i.layer=this.layer,i.sourceLayer=this.layer,i}_createGraphicsView(){const t=this.view,i=()=>this.requestUpdate(),r=new H(t.featuresTilingScheme);this._graphicsView=new C({container:r,graphics:this._graphics,requestUpdateCallback:i,view:t}),this.container.addChild(r),this._updateHighlight()}_destroyGraphicsView(){this.container.removeChild(this._graphicsView.container),this._graphicsView.destroy()}_getDrawOrder(t){const i=this._networkGraphicMap.get(t);return U.indexOf(i.type)}_getNetworkFeatureUid(t){return this._networkFeatureMap.has(t)?this._networkFeatureMap.get(t).uid:null}_removeHighlight(t){for(const i of t)if(this._highlightIds.has(i)){const r=this._highlightIds.get(i)-1;r===0?this._highlightIds.delete(i):this._highlightIds.set(i,r)}this._updateHighlight()}_routeItemsChanged(t){if(t.removed.length){this._graphics.removeMany(t.removed.map((i=>{const r=this._networkFeatureMap.get(i);return this._networkFeatureMap.delete(i),this._networkGraphicMap.delete(r),r})));for(const i of t.removed)this.removeHandles(i)}if(t.added.length){this._graphics.addMany(t.added.map((i=>{const r=this._createGraphic(i);return r.symbol==null?null:(this._networkFeatureMap.set(i,r),this._networkGraphicMap.set(r,i),r)})).filter(h));for(const i of t.added)this.addHandles([g((()=>i.geometry),((r,e)=>{this._updateGraphic(i,"geometry",r,e)})),g((()=>i.symbol),((r,e)=>{this._updateGraphic(i,"symbol",r,e)}))],i);this._graphics.sort(((i,r)=>this._getDrawOrder(i)-this._getDrawOrder(r)))}}_updateGraphic(t,i,r,e){if(!this._networkFeatureMap.has(t)){const a=this._createGraphic(t);return this._networkFeatureMap.set(t,a),this._networkGraphicMap.set(a,t),void this._graphics.add(a)}const o=this._networkFeatureMap.get(t);o[i]=r,s.graphic=o,s.property=i,s.oldValue=e,s.newValue=r,this._graphicsView.graphicUpdateHandler(s)}_updateHighlight(){const t=Array.from(this._highlightIds.keys());this._graphicsView.setHighlight(t)}};n([d()],p.prototype,"_graphics",void 0),n([d()],p.prototype,"_routeItems",null),p=n([_("esri.views.2d.layers.RouteLayerView2D")],p);const Fi=p;export{Fi as default};
