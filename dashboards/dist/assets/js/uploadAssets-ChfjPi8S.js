import{o as h,a5 as I,ec as es,cA as v,e as ts,fq as D,fr as S,bt as f,z as m,W as l,ct as os,eO as rs,X as ns,eN as as,s as is}from"./uuid-De2V3pkO.js";import{h as cs,A as us,N as ls,i as U,o as k}from"./External-CSsgmrs6.js";import{w as ps}from"./arcgisLayerUrl-DMpJLG2u.js";import{u as B,i as ds,s as ms}from"./infoFor3D-CKoUGm1M.js";import"./index-OAJD89tD.js";const g="upload-assets",w=()=>new Error;class fs extends h{constructor(){super(`${g}:unsupported`,"Layer does not support asset uploads.",w())}}class hs extends h{constructor(){super(`${g}:no-glb-support`,"Layer does not support glb.",w())}}let gs=class extends h{constructor(){super(`${g}:no-supported-source`,"No supported external source found",w())}},ws=class extends h{constructor(){super(`${g}:not-base-64`,"Expected gltf data in base64 format after conversion.",w())}},ys=class extends h{constructor(){super(`${g}:unable-to-prepare-options`,"Unable to prepare uploadAsset request options.",w())}};class bs extends h{constructor(t,s){super(`${g}:bad-response`,`Bad response. Uploaded ${t} items and received ${s} results.`,w())}}let Ps=class extends h{constructor(t,s){super(`${g}-layer:upload-failed`,`Failed to upload mesh file ${t}. Error code: ${s?.code??"-1"}. Error message: ${s?.messages??"unknown"}`,w())}};class O extends h{constructor(t){super(`${g}-layer:unsupported-format`,`The service allowed us to upload an asset of FormatID ${t}, but it does not list it in its supported formats.`,w())}}let $s=class extends h{constructor(){super(`${g}:convert3D-failed`,"convert3D failed.")}};const j={uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};function y(e,t=(o=>{}),s){return new Ts(e,t,s)}class Ts{constructor(t,s=(r=>{}),o){if(this.onProgress=s,this.taskName=o,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,typeof t=="number"){this._weights={};for(let r=0;r<t;r++){const n=r,a=1/t;this._weights[n]=a,this._progressMap.set(n,0)}}else this._weights=t;this.emitProgress()}emitProgress(){let t=0;for(const[s,o]of this._progressMap.entries())t+=o*this._weights[s];if(t===1&&I("enable-feature:esri-3dofl-upload-timings")){const s=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${s} sec`);for(const[o,r]of this._timingsMap){const n=Math.round(r.end-r.start)/1e3,a=Math.round(n/s*100);console.log(this.taskName??"Task",{stepKey:o,stepTime:n,relativeTime:a})}}this.onProgress(t)}setProgress(t,s){if(this._progressMap.set(t,s),I("enable-feature:esri-3dofl-upload-timings")){const o=performance.now();this._startTime??=o;const r=es(this._timingsMap,t,(()=>({start:o,end:0})));s===1&&(r.end=o)}this.emitProgress()}simulate(t,s){return q((o=>this.setProgress(t,o)),s)}makeOnProgress(t){return s=>this.setProgress(t,s)}}function q(e=(s=>{}),t=Fs){const s=performance.now();e(0);const o=setInterval((()=>{const r=performance.now()-s,n=1-Math.exp(-r/t);e(n)}),Es);return ts((()=>{clearInterval(o),e(1)}))}function As(e,t=vs){return D(S(e*C/t))}function xs(e,t=js){return D(S(e*C/t))}const vs=10,js=10,C=8e-6,Es=v(50),Fs=v(1e3),L=1e6,_=20*L,Ms=2e9,Ns=3;async function Is({data:e,name:t,description:s},o,r){let n=null;try{const a=f(o,"uploads"),i=f(a,"info"),{data:c}=await m(i,{query:{f:"json"},responseType:"json"});l(r);const u=ps(o),d=c.maxUploadFileSize*L,b=u?Ms:d,x=u?Math.min(_,d):_;if(e.size>b)throw new Error("Data too large");const W=f(a,"register"),{data:E}=await m(W,{query:{f:"json",itemName:_s(t),description:s},responseType:"json",method:"post"});if(l(r),!E.success)throw new Error("Registration failed");const{itemID:J}=E.item;n=f(a,J);const K=f(n,"uploadPart"),F=Math.ceil(e.size/x),P=new Array;for(let p=0;p<F;++p)P.push(e.slice(p*x,Math.min((p+1)*x,e.size)));const $=P.slice().reverse(),M=new Array,V=y(F,r?.onProgress,"uploadItem"),X=async()=>{for(;$.length!==0;){const p=P.length-$.length,T=$.pop(),A=new FormData,Y=V.simulate(p,As(T.size));try{const Z=T;A.append("f","json"),A.append("file",Z),A.append("partId",`${p}`);const{data:ss}=await m(K,{timeout:0,body:A,responseType:"json",method:"post"});if(l(r),!ss.success)throw new Error("Part upload failed")}finally{Y.remove()}}};for(let p=0;p<Ns&&$.length!==0;++p)M.push(X());await Promise.all(M);const Q=f(n,"commit"),{data:N}=await m(Q,{query:{f:"json",parts:P.map(((p,T)=>T)).join(",")},responseType:"json",method:"post"});if(l(r),!N.success)throw new Error("Commit failed");return N.item}catch(a){if(n!=null){const i=f(n,"delete");await m(i,{query:{f:"json"},responseType:"json",method:"post"})}throw a}}function _s(e){return e.replaceAll("/","_").replaceAll("\\","_")}async function ue(e,t,s){const o=e.length;if(!o)return s?.onProgress?.(1),[];const r=y(o,s?.onProgress,"uploadAssets");return Promise.all(e.map(((n,a)=>Ds(n,t,{...s,onProgress:r.makeOnProgress(a)}))))}async function Ds(e,{layer:t,ongoingUploads:s},o){const r=s.get(e);if(r)return r;if(!Xs(t))throw new fs;if(Ss(e,t))return o?.onProgress?.(1),e;const n=Us(e,t,o);s.set(e,n);try{await n}finally{s.delete(e)}return e}function Ss(e,t){const{parsedUrl:s}=t;return s!=null&&e.metadata.externalSources.some((o=>cs(o,s)))}async function Us(e,t,s){const{metadata:o}=e,{displaySource:r}=o,n=R(r?.source,t),a=!!n,i=o.externalSources.length>0,c=a?ks(n,t,s):i?Bs(e,t,s):Os(e,t,s),u=await c;return l(s),e.addExternalSources([u]),e}async function ks(e,t,s){return{source:await z(e,t,s),original:!0}}async function Bs(e,t,s){const o=G(t),{externalSources:r}=e.metadata,n=Cs(r,t);if(!n)throw new gs;const a=y(j.uploadConvertibleSource,s?.onProgress,"uploadConvertibleSource"),i=await z(n,t,{onProgress:a.makeOnProgress("uploadEditSource")});e.addExternalSources([{source:i,original:!0}]);const c=n.reduce(((d,{asset:b})=>b instanceof File?d+b.size:d),0),u=a.simulate("serviceAssetsToGlb",xs(c));try{return{source:await Js(i,t,o)}}finally{u.remove()}}async function Os(e,t,s){const o=y(j.uploadLocalMesh,s?.onProgress,"uploadLocalMesh"),r=qs(e,t,{...s,onProgress:o.makeOnProgress("meshToAssetBlob")});return{source:await H([r],t,{...s,onProgress:o.makeOnProgress("uploadAssetBlobs")}),extent:e.extent.clone(),original:!0}}async function qs(e,t,s){const o=G(t),r=await e.load(s),n=await r.toBinaryGLTF({ignoreLocalTransform:!0});l(s);const a=await n.buffer();return l(s),{blob:new Blob([a.data],{type:a.type}),assetName:`${os()}.glb`,assetType:o}}function Cs(e,t){for(const s of e){const o=R(s.source,t);if(o)return o}return null}function R(e,t){if(!e)return null;const{infoFor3D:{supportedFormats:s,editFormats:o}}=t,r=us(e),n=new Array;let a=!1;for(let i=0;i<r.length;++i){const c=Ls(r[i],s);if(!c)return null;o.includes(c.assetType)&&(a=!0),n.push(c)}return a?n:null}function Ls(e,t){const s=ls(e,t);return s?{asset:e,assetType:s}:null}async function z(e,t,s){return H(e.map((o=>Rs(o,s))),t,s)}async function H(e,t,s){const o=y(j.uploadAssetBlobs,s?.onProgress,"uploadAssetBlobs"),r=await Hs(e,t,{...s,onProgress:o.makeOnProgress("prepareAssetItems")});l(s);const n=r.map((({item:i})=>i)),{uploadResults:a}=await Gs(n,t,{...s,onProgress:o.makeOnProgress("uploadAssetItems")});return l(s),e.map(((i,c)=>Ws(r[c],a[c],t)))}async function Rs(e,t){const{asset:s,assetType:o}=e;if(s instanceof File)return{blob:s,assetName:s.name,assetType:o};const r=await s.toBlob(t);return l(t),{blob:r,assetName:s.assetName,assetType:o}}async function zs(e,t,s){const{blob:o,assetType:r,assetName:n}=e;let a=null;try{const i=await Is({data:o,name:n},t.url,s);l(s),a={assetType:r,assetUploadId:i.itemID}}catch(i){ns(i),Qs().warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!a){const i=await as(o);if(l(s),!i.isBase64)throw new ws;a={assetType:r,assetData:i.data}}if(!a)throw new ys;return{item:a,assetName:n}}function Hs(e,t,s){const o=y(e.length,s?.onProgress,"prepareAssetItems");return Promise.all(e.map((async(r,n)=>{const a=zs(await r,t,{...s,onProgress:o.makeOnProgress(n)});return l(s),a})))}async function Gs(e,t,s){const o=q(s?.onProgress);try{const r=await m(f(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if(l(s),r.data.uploadResults.length!==e.length)throw new bs(e.length,r.data.uploadResults.length);return r.data}finally{o.remove()}}function Ws(e,t,s){const{success:o}=t;if(!o){const{error:u}=t;throw new Ps(e.assetName,u)}const{assetHash:r}=t,{assetName:n,item:{assetType:a}}=e,{infoFor3D:{supportedFormats:i}}=s,c=ms(a,i);if(!c)throw new O(a);return new U(n,c,[new k(`${s.parsedUrl.path}/assets/${r}`,r)])}async function Js(e,t,s){const o=e.map((({assetName:u,parts:d})=>({assetName:u,assetHash:d[0].partHash}))),r=t.capabilities?.operations.supportsAsyncConvert3D,n={f:"json",assets:JSON.stringify(o),transportType:"esriTransportTypeUrl",targetFormat:s,async:r},a=f(t.parsedUrl.path,"convert3D");let i;try{i=(await(r?Vs:Ks)(a,{query:n,responseType:"json",timeout:0})).data}catch{throw new $s}const{supportedFormats:c}=t.infoFor3D;return i.assets.map((u=>{const d=B(u.contentType,c);if(!d)throw new O(d);return new U(u.assetName,u.contentType,[new k(u.assetURL,u.assetHash)])}))}function Ks(e,t){return m(e,t)}async function Vs(e,t){const s=(await m(e,t)).data.statusUrl;for(;;){const o=(await m(s,{query:{f:"json"},responseType:"json"})).data;switch(o.status){case"Completed":return m(o.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(o.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}await rs(Ys)}}function Xs(e){return!!e.infoFor3D&&!!e.url}function G(e){const{infoFor3D:t}=e,s=B("model/gltf-binary",t.supportedFormats)??ds("glb",t.supportedFormats);if(!s)throw new hs;return s}function Qs(){return is.getLogger("esri.layers.graphics.sources.support.uploadAssets")}const Ys=v(1e3);export{ue as uploadAssets};
