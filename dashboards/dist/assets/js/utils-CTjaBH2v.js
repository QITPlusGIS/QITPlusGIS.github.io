import{Z as I,o as l}from"./uuid-De2V3pkO.js";import{i as u}from"./originUtils-Bf8nVymy.js";import b from"./PortalItem-C8IOgJp9.js";import{o as c}from"./jsonContext-BvsZzvt8.js";import{i as g,f as h}from"./portalItemUtils-2ng-Kvae.js";import{i as S}from"./saveAPIKeyUtils-C5NwgnmH.js";function x(t,a,r){const e=r(t);if(!e.isValid)throw new l(`${a}:invalid-parameters`,e.errorMessage,{layer:t})}async function f(t){const{layer:a,errorNamePrefix:r,validateLayer:e}=t;await a.load(),x(a,r,e)}function d(t,a){return`Layer (title: ${t.title}, id: ${t.id}) of type '${t.declaredClass}' ${a}`}function y(t){const{item:a,itemType:r,errorNamePrefix:e,layer:n,validateItem:s}=t;if(S(a),a.type!==r)throw new l(`${e}:portal-item-wrong-type`,`Portal item type should be "${r}"`,{item:a,layer:n});if(s){const i=s(a);if(!i.isValid)throw new l(`${e}:invalid-parameters`,i.errorMessage,{layer:n})}}function N(t){const{layer:a,errorNamePrefix:r}=t,{portalItem:e}=a;if(!e)throw new l(`${r}:portal-item-not-set`,d(a,"requires the portalItem property to be set"));if(!e.loaded)throw new l(`${r}:portal-item-not-loaded`,d(a,"cannot be saved to a portal item that does not exist or is inaccessible"));y({...t,item:e})}function P(t){const{newItem:a,itemType:r}=t;let e=b.from(a);return e.id&&(e=e.clone(),e.id=null),e.type??=r,e.portal??=I.getDefault(),y({...t,item:e}),e}function O(t,a){let r=(t.messages??[]).filter((({type:e})=>e==="error")).map((({name:e,message:n,details:s})=>new l(e,n,s)));if(t.blockedRelativeUrls&&(r=r.concat(t.blockedRelativeUrls.map((e=>new l("url:unsupported",`Relative url '${e}' is not supported`))))),a?.ignoreUnsupported&&(r=r.filter((({name:e})=>e!=="layer:unsupported"&&e!=="symbol:unsupported"&&e!=="symbol-layer:unsupported"&&e!=="property:unsupported"&&e!=="url:unsupported"))),r.length>0)throw new l("layer-write:unsupported","Failed to save layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}async function w(t,a,r){"beforeSave"in t&&typeof t.beforeSave=="function"&&await t.beforeSave();const e=t.write({},a);return await Promise.all(a.resources?.pendingOperations??[]),O(a,r),e}function $(t){g(t,h.JSAPI),t.typeKeywords&&(t.typeKeywords=t.typeKeywords.filter(((a,r,e)=>e.indexOf(a)===r)))}async function J(t,a,r){const e=t.portal;await e.signIn(),await e.user?.addItem({item:t,data:a,folder:r?.folder})}async function L(t,a){const{layer:r,createItemData:e,createJSONContext:n,saveResources:s}=t;await f(t),N(t);const i=r.portalItem,o=n?n(i):c(i),p=await w(r,o,a),m=await e({layer:r,layerJSON:p},i);return $(i),await i.update({data:m}),u(o),await s?.(i,o),i}async function M(t,a){const{layer:r,createItemData:e,createJSONContext:n,setItemProperties:s,saveResources:i}=t;await f(t);const o=P(t),p=n?n(o):c(o),m=await w(r,p,a),v=await e({layer:r,layerJSON:m},o);return await s(r,o),$(o),await J(o,v,a),r.portalItem=o,u(p),await i?.(o,p),o}export{L as I,M as b,N as d,x as l,d as m,P as u,J as v,$ as w,w as y};
