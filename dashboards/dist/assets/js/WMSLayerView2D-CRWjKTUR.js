import{a as p,y as n,c as b,u as S,o as g,b as C,s as E,f as R,S as $}from"./uuid-De2V3pkO.js";import{a as I}from"./BitmapContainer-Bb31b7ue.js";import{m as q,u as U}from"./LayerView-DVe-QqFJ.js";import{v as V}from"./ExportStrategy-CeDZbdMl.js";import{a as W}from"./RefreshableLayerView-D4pqx1y-.js";import{j as L}from"./commonProperties-7y88ic0r.js";import{o as j}from"./ExportWMSImageParameters-DX7XCClq.js";import"./index-OAJD89tD.js";import"./WGLContainer-CCreaUuQ.js";import"./definitions-DYuD04dF.js";import"./FramebufferObject-BKEPrhyG.js";import"./Texture-BUpON3bN.js";import"./capabilities-BeSycj8J.js";import"./enums-BFYfP9qy.js";import"./ProgramTemplate-CzjMKiq1.js";import"./commonjsHelpers-DCkdB7M8.js";import"./VertexElementDescriptor-BLyltQyJ.js";import"./color-cT1-Ge3_.js";import"./enums-lYQiQBYo.js";import"./GeometryUtils-CzofDDjY.js";import"./heatmapUtils-DncJMPvQ.js";import"./vec4f64-Jk3PXxMO.js";import"./mat3f32-BPgNI_lm.js";import"./StyleDefinition-C8U8LdH5.js";import"./vec2f32-DJy8k_UQ.js";import"./config-BOD8--da.js";import"./Container-DX7KQTHt.js";import"./parser-CQvYRaWk.js";import"./mat4f32-BYh1DbDV.js";import"./mat4-DR7ljCfE.js";import"./earcut-BVL67bTw.js";import"./vec2-C6Y96AwR.js";import"./vec2f64-BuJjW9A-.js";import"./featureConversionUtils-BBvLZPS5.js";import"./OptimizedFeature-CuDeWVOV.js";import"./OptimizedFeatureSet-Blu9Ckm7.js";import"./scaleUtils-ApfxRMLk.js";import"./map-BEES39Ai.js";import"./Basemap-DVlQKLRn.js";import"./loadAll-Cim39wYP.js";import"./PortalItem-C8IOgJp9.js";import"./writeUtils-993Cp9iz.js";import"./layerUtils-D8dZn4eh.js";import"./compilerUtils-BndV9QTL.js";import"./CollectionFlattener-BEJgaFwb.js";import"./infoFor3D-CKoUGm1M.js";import"./basemapUtils-BPWzFCB8.js";import"./TablesMixin-BAh-Tdsn.js";import"./arcgisLayerUrl-DMpJLG2u.js";import"./Cyclical-bCBpTSsi.js";import"./workers-Dp_XhR59.js";import"./TileInfo-ybWiFFHA.js";import"./jsxFactory-CrT0-KGb.js";import"./UpdatingHandles-7vim6dHb.js";import"./signal-C4o35hpO.js";import"./GraphicsCollection-DbKTAY2Z.js";import"./ViewingMode-HRfKv6NR.js";import"./unitBezier-C3UyU2rI.js";import"./mat2df32-Y88URbH1.js";import"./TileStore-DTOce_SM.js";import"./quickselect-Dsa-MazW.js";import"./QuantizationParameters-DrrRb5JH.js";import"./TileInfoView-CccucBWX.js";import"./normalizeUtils-CHaYFzrc.js";import"./normalizeUtilsCommon-vfKhPTnw.js";import"./mat3-Riwg5JNu.js";import"./GoTo-BYKJE8LR.js";import"./Bitmap-CWIo4k0z.js";import"./ElevationInfo-C7w4yfnq.js";import"./lengthUtils-C4EPlNSZ.js";const H=e=>{let t=class extends e{initialize(){this.exportImageParameters=new j({layer:this.layer})}destroy(){this.exportImageParameters=S(this.exportImageParameters)}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}fetchPopupFeatures(o){const{layer:i}=this;if(!o)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:i}));const{popupEnabled:m}=i;if(!m)return Promise.reject(new g("wmslayerview:fetchPopupFeatures","popupEnabled should be true",{popupEnabled:m}));const u=this.createFetchPopupFeaturesQuery(o);if(!u)return Promise.resolve([]);const{extent:r,width:a,height:s,x:d,y:c}=u;if(!(r&&a&&s))throw new g("wmslayerview:fetchPopupFeatures","WMSLayer does not support fetching features.",{extent:r,width:a,height:s});return i.fetchFeatureInfo(r,a,s,d,c)}};return p([n()],t.prototype,"exportImageParameters",void 0),p([n({readOnly:!0})],t.prototype,"exportImageVersion",null),p([n()],t.prototype,"layer",void 0),p([n(L)],t.prototype,"timeExtent",void 0),t=p([b("esri.layers.mixins.WMSLayerView")],t),t};let h=class extends H(W(q(U))){constructor(){super(...arguments),this.bitmapContainer=new I}supportsSpatialReference(e){return this.layer.serviceSupportsSpatialReference(e)}update(e){this.strategy.update(e).catch((t=>{C(t)||E.getLogger(this).error(t)}))}attach(){const{layer:e}=this,{imageMaxHeight:t,imageMaxWidth:o}=e;this.bitmapContainer=new I,this.container.addChild(this.bitmapContainer),this.strategy=new V({container:this.bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:t,imageMaxWidth:o,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1}),this.addAttachHandles(R((()=>this.exportImageVersion),(()=>this.requestUpdate())))}detach(){this.strategy=S(this.strategy),this.container.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}createFetchPopupFeaturesQuery(e){const{view:t,bitmapContainer:o}=this,{x:i,y:m}=e,{spatialReference:u}=t;let r,a=0,s=0;if(o.children.some((F=>{const{width:f,height:x,resolution:w,x:y,y:l}=F,v=y+w*f,P=l-w*x;return i>=y&&i<=v&&m<=l&&m>=P&&(r=new $({xmin:y,ymin:P,xmax:v,ymax:l,spatialReference:u}),a=f,s=x,!0)})),!r)return null;const d=r.width/a,c=Math.round((i-r.xmin)/d),M=Math.round((r.ymax-m)/d);return{extent:r,width:a,height:s,x:c,y:M}}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(e,t,o,i){return this.layer.fetchImageBitmap(e,t,o,{timeExtent:this.timeExtent,...i})}};p([n()],h.prototype,"strategy",void 0),p([n()],h.prototype,"updating",void 0),h=p([b("esri.views.2d.layers.WMSLayerView2D")],h);const te=h;export{te as default};
