import{S as Ve,aC as K,lc as Zt,ld as Ce,le as Re,bj as O,fM as At,lf as xt,he as B,jk as ae,cY as $,bO as re,c_ as Ot,lg as ze,lh as Ge,fX as kt,R as at,aF as De,aE as Fe,li as se,ad as zt,ev as Ze,aD as Ae,cR as ke,W as le,ht as Z,lj as He,eH as $t,lk as Ue,fo as We,V as Le,a as l,aS as pe,ll as F,ac as Ne,s as qe,b as c,c as E,aP as je,aj as Gt,lm as yt,dk as mt,dp as Ye,l as L,j as D,m as Xe,b9 as Be,ln as Dt,aN as Je,cP as ut,lo as dt,dK as ft,dn as ce,cX as Ke,aa as Ht,du as he,lp as Qe,lq as ue,lr as de,dq as Pt,ga as ge,kd as Et,ew as ye,eL as tn,ls as en,lt as nn,aJ as on,js as an,eJ as rn,hD as Ut,cU as me,bG as sn,f$ as ot,lu as Wt,fv as Lt,lv as Nt,k6 as fe,fp as j,lw as it,lx as qt,ly as ln,lz as pn,d3 as cn,lA as wt,lB as jt,lC as M,cZ as Yt,lD as hn,fZ as bt}from"./index-f2dd40fe.js";import{t as Q,m as V,U as J,r as Xt,p as un,s as Tt,d as dn,b as Bt,c as st}from"./automaticLengthMeasurementUtils-3fa4f5de.js";import{simplify as gn,distance as yn}from"./geometryEngine-ac6f3474.js";import{s as mn}from"./centroid-fad5df76.js";import{o as Jt,e as It,w as fn,_ as vn,p as _n,l as xn,t as wn,b as bn,s as Tn,c as Sn}from"./SnappingContext-ed145fae.js";import{M as Mn,x as vt}from"./hydratedFeatures-5bd81c31.js";import{a as On}from"./interfaces-1a80c8eb.js";import{r as ve}from"./GraphicManipulator-3cd5a580.js";function Vt(e,t){return e===t||e!=null&&t!=null&&Ve(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function gt(e,t,n=null){return n!=null?[e,t,n]:[e,t]}function _(e,t,n=null){return n!=null?{x:e,y:t,z:n}:{x:e,y:t}}let _e=class{constructor(t){this.spatialReference=t}mapToLocalMultiple(t){return t.map(n=>this.mapToLocal(n)).filter(at)}get doUnnormalization(){return!1}};class $n extends _e{constructor(t,n,i=null){super(n),this._defaultZ=i,this.transform=Zt(),this.transformInv=Zt(),this.transform=Ce(t),Re(this.transformInv,this.transform)}makeMapPoint(t,n){return gt(t,n,this._defaultZ)}mapToLocal(t){return _(this.transform[0]*t[0]+this.transform[2]*t[1]+this.transform[4],this.transform[1]*t[0]+this.transform[3]*t[1]+this.transform[5])}localToMap(t){return gt(this.transformInv[0]*t.x+this.transformInv[2]*t.y+this.transformInv[4],this.transformInv[1]*t.x+this.transformInv[3]*t.y+this.transformInv[5],this._defaultZ)}}let Pn=class extends _e{constructor(t,n){super(t.spatialReference),this.view=t,this.defaultZ=null,this.pWS=O(),this.tangentFrameUpWS=O(),this.tangentFrameRightWS=O(),this.tangentFrameForwardWS=O(),this.localFrameRightWS=O(),this.localFrameUpWS=O(),this.worldToLocalTransform=At(),this.localToWorldTransform=At(),this.scale=1,this.scale=t.resolution,this.referenceMapPoint=n,this.defaultZ=n.hasZ?n.z:null;const i=t.state.camera.viewRight;this.view.renderCoordsHelper.toRenderCoords(this.referenceMapPoint,this.pWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,xt.X,this.tangentFrameRightWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,xt.Y,this.tangentFrameUpWS),this.view.renderCoordsHelper.worldBasisAtPosition(this.pWS,xt.Z,this.tangentFrameForwardWS);const o=O();B(o,this.tangentFrameForwardWS,ae(i,this.tangentFrameForwardWS)),$(this.localFrameRightWS,i,o),re(this.localFrameRightWS,this.localFrameRightWS),Ot(this.localFrameUpWS,this.tangentFrameForwardWS,this.localFrameRightWS),ze(this.worldToLocalTransform,this.localFrameRightWS,this.tangentFrameRightWS),Ge(this.localToWorldTransform,this.worldToLocalTransform)}get doUnnormalization(){return this.view.viewingMode==="global"}makeMapPoint(t,n){return gt(t,n,this.defaultZ)}mapToLocal(t){const n=O();this.view.renderCoordsHelper.toRenderCoords(new K({x:t[0],y:t[1],spatialReference:this.spatialReference}),n),kt(n,n,this.worldToLocalTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference);return i!=null?_(i.x/this.scale,i.y/this.scale):null}localToMap(t){const n=O();this.view.renderCoordsHelper.toRenderCoords(new K({x:t.x*this.scale,y:t.y*this.scale,spatialReference:this.spatialReference}),n),kt(n,n,this.localToWorldTransform);const i=this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference);return i!=null?gt(i.x,i.y,this.defaultZ):null}};function Kt(e,t){if(e.type==="2d")return new $n(e.state.transform,e.spatialReference,t.length>2?t[2]:null);if(e.type==="3d"){const n=t.length>2?new K({x:t[0],y:t[1],z:t[2],spatialReference:e.spatialReference}):new K({x:t[0],y:t[1],spatialReference:e.spatialReference});return new Pn(e,n)}return null}function N(e,t){const n=new K({x:e[0],y:e[1],spatialReference:t});return e.length>2&&(n.z=e[2]),n}function En(e,t){return new De({points:e,spatialReference:t})}function Qt(e,t,n){const i=new Fe({paths:e,spatialReference:t});return n&&se(i),i}function q(e,t,n,i=!0){const o=zt(e);o.forEach(s=>{const r=s[0],p=s[s.length-1];Ze(r,p)&&s.length!==1||s.push(s[0])});let a=new Ae({rings:o,spatialReference:t});return a.rings.forEach(s=>{ke(s,!1,!1)||s.reverse()}),n&&se(a),i&&a.isSelfIntersecting&&le(t)&&(a=gn(a)),a}function te(e,t,n){const i=t.mapToLocalMultiple(e),o=[],a={x:i[0].x,y:i[0].y},s={x:i[1].x,y:i[1].y},r=Math.round(s.x-a.x),p=Math.round(s.y-a.y),d=Math.max(Math.abs(r),Math.abs(p));if(n){const h={x:a.x+d,y:a.y+d},g={x:a.x-d,y:a.y-d};o.push(_(h.x,g.y),_(g.x,g.y),_(g.x,h.y),_(h.x,h.y))}else{const h={x:r>0?a.x+d:a.x-d,y:p>0?a.y+d:a.y-d};o.push(_(a.x,a.y),_(h.x,a.y),_(h.x,h.y),_(a.x,h.y))}return xe(q([o.map(h=>t.localToMap(h)).filter(at)],t.spatialReference,t.doUnnormalization,!0),o,t)}function In(e,t,n){let i=t.mapToLocalMultiple(e);if(i.length===1){const p=i[0];i=[_(p.x-48,p.y+48),_(p.x+48,p.y-48),_(p.x+48,p.y-48),_(p.x-48,p.y+48)]}const o=[],a={x:i[0].x,y:i[0].y},s={x:i[1].x,y:i[1].y};if(n){const r=Math.round(s.x-a.x),p=Math.round(s.y-a.y);o.push(_(a.x-r,a.y-p),_(s.x,a.y-p),_(s.x,s.y),_(a.x-r,s.y))}else o.push(_(a.x,a.y),_(s.x,a.y),_(s.x,s.y),_(a.x,s.y));return xe(q([o.map(r=>t.localToMap(r)).filter(at)],t.spatialReference,t.doUnnormalization,!0),o,t)}function xe(e,t,n){const i=lt(t[3],t[2],n),o=lt(t[1],t[2],n),a=lt(t[0],t[1],n),s=lt(t[0],t[3],n);return{geometry:e,midpoints:i!=null&&o!=null&&a!=null&&s!=null?{top:i,right:o,bottom:a,left:s}:null}}function lt(e,t,n){Y[0]=e.x,Y[1]=e.y,Y[2]=0,X[0]=t.x,X[1]=t.y,X[2]=0,Z(Y,Y,X,.5),pt.x=Y[0],pt.y=X[1],pt.z=X[2];const i=n.localToMap(pt);return i!=null?N(i,n.spatialReference):null}const pt=_(0,0,0),Y=O(),X=O();function ee(e,t,n,i){const o=t.mapToLocalMultiple(e);let a=null,s=null;if(n)a=o[0],s=o[1];else{const v=o[0],f=o[1],w=Math.round(f.x-v.x),T=Math.round(f.y-v.y),S=Math.max(Math.abs(w),Math.abs(T));a=_(w>0?v.x+S/2:v.x-S/2,T>0?v.y+S/2:v.y-S/2),s=_(Math.abs(w)>Math.abs(T)?a.x-S/2:a.x,Math.abs(w)>Math.abs(T)?a.y:a.y-S/2)}const r=t.localToMap(a),p=t.localToMap(s);if(r==null||p==null)return null;t.doUnnormalization&&He([[r,p]],t.spatialReference);const d=N(r,t.spatialReference),h=N(p,t.spatialReference),g=$t(t.spatialReference);let y=0;if(le(t.spatialReference))y=g*yn(d,h,null);else{const v=a.x-s.x,f=a.y-s.y;y=g*Math.sqrt(v*v+f*f)*(i||1)}const u=new Ue({center:d,radius:y,radiusUnit:"meters",spatialReference:t.spatialReference});return{geometry:q(u.rings,u.spatialReference,!1),center:d,edge:h}}function Vn(e,t,n){const i=t.mapToLocalMultiple(e),o=i[0],a=i[1],s=Math.round(a.x-o.x),r=Math.round(a.y-o.y),p=_(n?o.x:o.x+s/2,n?o.y:o.y+r/2),d=n?s:s/2,h=n?r:r/2,g=60,y=[],u=2*Math.PI/g;function v(P){const nt=Math.cos(P),rt=Math.sin(P);return _(d*nt+p.x,h*rt+p.y)}for(let P=0;P<g;P++)y.push(v(P*u));y.push(y[0]);const{spatialReference:f,doUnnormalization:w}=t,T=q([y.map(P=>t.localToMap(P)).filter(at)],f,w,!1),S=t.localToMap(v(Math.PI/2)),C=t.localToMap(v(0)),tt=t.localToMap(v(-Math.PI/2)),et=t.localToMap(v(Math.PI));return{geometry:T,midpoints:S!=null&&C!=null&&tt!=null&&et!=null?{top:N(S,f),right:N(C,f),bottom:N(tt,f),left:N(et,f)}:null}}function ct(e,t,n){switch(e){case"point":case"multipoint":return"point";case"polyline":return(t!=null&&t.type==="polyline"&&t.paths.length?t.paths[0].length:0)<2?"polylineZeroVertices":"polylineOneVertex";case"polygon":{const i=t!=null&&t.type==="polygon"&&t.rings.length?t.rings[0].length:0;return i<3?"polylineZeroVertices":i<4?"polygonOneVertex":"polygonTwoVertices"}case"mesh":return Cn(t,n);default:return}}function Cn(e,t){if((e==null?void 0:e.type)!=="mesh"||(t==null?void 0:t.type)!=="3d")return;const{renderCoordsHelper:n}=t,{camera:i}=t.state,{width:o,height:a,zmin:s,zmax:r,center:p,spatialReference:d}=e.extent,h=(r??0)-(s??0),g=$t(d),y=mn(d),u=$t(n.spatialReference),v=Math.max(o*g,a*g,h*y)/u;We(ht,p.x,p.y,p.z??0),n.toRenderCoords(ht,d,ht);const f=v/i.computeScreenPixelSizeAt(ht);return f>i.width*zn?"meshTooClose":f<Rn?"meshTooFar":"mesh"}const Rn=20,zn=1,ht=O();var W;(function(e){e[e.WhenToolEditable=0]="WhenToolEditable",e[e.WhenToolNotEditable=1]="WhenToolNotEditable",e[e.Always=2]="Always"})(W||(W={}));class Gn{constructor(){this._isToolEditable=!0,this._manipulators=new Le,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,n=W.WhenToolEditable){this.addMany([t],n)}addMany(t,n=W.WhenToolEditable){for(const i of t){const o={manipulator:i,visibilityPredicate:n,attached:!1};this._manipulators.add(o),this._attached&&this._updateManipulatorAttachment(o)}}remove(t){for(let n=0;n<this._manipulators.length;n++)if(this._manipulators.at(n).manipulator===t){const i=this._manipulators.splice(n,1)[0];this._detachManipulator(i);break}}removeAll(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(t=>{this._updateManipulatorAttachment(t)}),this._attached=!0}detach(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:t})=>{t.destroy&&t.destroy()}),this._manipulators.destroy(),this._resourceContexts=null}on(t,n){return this._manipulators.on(t,i=>{n(i)})}forEach(t){for(const n of this._manipulators.items)t(n)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach(n=>t.push(n.manipulator)),t}intersect(t,n){let i=null,o=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:a,attached:s})=>{if(!s||!a.interactive)return;const r=a.intersectionDistance(t,n);r!=null&&r<o&&(o=r,i=a)}),i}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const n=t.manipulator;n.grabbing=!1,n.dragging=!1,n.hovering=!1,n.selected=!1,n.detach&&n.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===W.Always||(this._isToolEditable?t.visibilityPredicate===W.WhenToolEditable:t.visibilityPredicate===W.WhenToolNotEditable)}}let b=class extends pe{constructor(t){super(t),this.manipulators=new Gn,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[F.MANAGER,!0],[F.USER,!0]]),this._creationFinishedResolver=Ne()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(F.USER)}set editable(t){this.setEditableFlag(F.USER,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){this.view!=null?(this.view.focus(),this.onActivate()):qe.getLogger(this).error("Can't activate tool if view is not defined.")}deactivate(){this.onDeactivate()}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,n){this._editableFlags.set(t,n),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===F.USER&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(F.USER)&&this.getEditableFlag(F.MANAGER)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};l([c({constructOnly:!0})],b.prototype,"view",void 0),l([c({readOnly:!0})],b.prototype,"active",null),l([c({value:!0})],b.prototype,"visible",null),l([c({value:!0})],b.prototype,"editable",null),l([c({readOnly:!0})],b.prototype,"manipulators",void 0),l([c({readOnly:!0})],b.prototype,"updating",null),l([c()],b.prototype,"cursor",null),l([c({readOnly:!0})],b.prototype,"automaticManipulatorSelection",void 0),l([c()],b.prototype,"hasFocusedManipulators",null),l([c()],b.prototype,"hasGrabbedManipulators",void 0),l([c()],b.prototype,"hasHoveredManipulators",void 0),l([c()],b.prototype,"firstGrabbedManipulator",void 0),l([c({readOnly:!0})],b.prototype,"created",void 0),l([c({readOnly:!0})],b.prototype,"removeIncompleteOnCancel",void 0),b=l([E("esri.views.interactive.InteractiveToolBase")],b);let A=class extends Q{constructor(e){super(e),this.type="draw-point"}};l([c()],A.prototype,"type",void 0),l([c()],A.prototype,"elevation",void 0),l([c()],A.prototype,"viewType",void 0),l([c()],A.prototype,"helpMessage",void 0),A=l([E("esri.views.interactive.tooltip.DrawPointTooltipInfo")],A);let R=class extends Q{constructor(e){super(e),this.type="draw-polyline",this.totalLength=V}};l([c()],R.prototype,"type",void 0),l([c()],R.prototype,"elevation",void 0),l([c()],R.prototype,"totalLength",void 0),l([c()],R.prototype,"viewType",void 0),l([c()],R.prototype,"helpMessage",void 0),R=l([E("esri.views.interactive.tooltip.DrawPolylineTooltipInfo")],R);let z=class extends Q{constructor(e){super(e),this.type="draw-polygon",this.area=J}};l([c()],z.prototype,"type",void 0),l([c()],z.prototype,"elevation",void 0),l([c()],z.prototype,"area",void 0),l([c()],z.prototype,"viewType",void 0),l([c()],z.prototype,"helpMessage",void 0),z=l([E("esri.views.interactive.tooltip.DrawPolygonTooltipInfo")],z);let k=class extends Q{constructor(t){super(t),this.type="draw-mesh"}};l([c()],k.prototype,"type",void 0),l([c()],k.prototype,"elevation",void 0),l([c()],k.prototype,"viewType",void 0),l([c()],k.prototype,"helpMessage",void 0),k=l([E("esri.views.interactive.tooltip.DrawMeshTooltipInfo")],k);let H=class extends Q{constructor(t){super(t),this.type="draw-rectangle",this.xSize=V,this.ySize=V,this.area=J}};l([c()],H.prototype,"type",void 0),l([c()],H.prototype,"xSize",void 0),l([c()],H.prototype,"ySize",void 0),l([c()],H.prototype,"area",void 0),H=l([E("esri.views.interactive.tooltip.DrawRectangleTooltipInfo")],H);let G=class extends Q{constructor(e){super(e),this.type="draw-circle",this.radius=null,this.xSize=null,this.ySize=null,this.area=J}};l([c()],G.prototype,"type",void 0),l([c()],G.prototype,"radius",void 0),l([c()],G.prototype,"xSize",void 0),l([c()],G.prototype,"ySize",void 0),l([c()],G.prototype,"area",void 0),G=l([E("esri.views.interactive.tooltip.DrawCircleTooltipInfo")],G);let Dn=class{constructor(){this.regularVertices=null,this.activeVertex=null,this.full=null,this.outline=null,this.circle=null,this.rectangle=null}},m=class extends je(Gt.EventedMixin(b)){constructor(t){super(t),this._graphic=null,this._createOperationGeometry=null,this.defaultZ=0,this.geometryType=null,this.hasZ=!0,this.labelOptions=new yt,this.geometryToPlace=null,this.mode=null,this.snappingManager=null,this.snapToScene=!1,this.tooltip=null,this.tooltipOptions=new mt}initialize(){this.internalGraphicsLayer=new Ye({listMode:"hide",internal:!0}),this.view.map.layers.add(this.internalGraphicsLayer),this.drawOperation=this.makeDrawOperation(),this.handles.add([this.drawOperation.on("vertex-add",t=>this.onVertexAdd(t)),this.drawOperation.on("vertex-remove",t=>this.onVertexRemove(t)),this.drawOperation.on("vertex-update",t=>this.onVertexUpdate(t)),this.drawOperation.on("cursor-update",t=>this.onCursorUpdate(t)),this.drawOperation.on("complete",t=>this.onComplete(t)),L(()=>this.tooltipOptions.enabled,t=>{this.tooltip=t?new dn({view:this.view,info:this._tooltipInfo}):D(this.tooltip)},ut),L(()=>this._tooltipInfo,t=>{this.tooltip!=null&&(this.tooltip.info=t)},ut)]),this.finishToolCreation()}destroy(){this.drawOperation=D(this.drawOperation),this.tooltip=D(this.tooltip),this._destroyAllVisualisations(),this.view.map.remove(this.internalGraphicsLayer),this.internalGraphicsLayer=D(this.internalGraphicsLayer),this._set("view",null)}get _defaultElevation(){return Xt(this.defaultZ,"meters")}get canRedo(){return this.drawOperation.canRedo}get canUndo(){return this.drawOperation.canUndo}set centered(t){this._set("centered",t),this._updateGraphic()}set enabled(t){this.drawOperation.interactive=t,this._set("enabled",t)}set forceUniformSize(t){this._set("forceUniformSize",t),this._updateGraphic()}get graphic(){return this._graphic}set graphicSymbol(t){this._set("graphicSymbol",t),this._graphic!=null&&(this._graphic.symbol=t)}get updating(){var t;return((t=this.drawOperation)==null?void 0:t.updating)??!1}completeCreateOperation(){this.drawOperation.complete()}onInputEvent(t){this.drawOperation.onInputEvent(t)}redo(){this.drawOperation.redo()}reset(){}undo(){this.drawOperation.undo()}_destroyAllVisualisations(){this.handles.remove(I.outline),this.handles.remove(I.regularVertices),this.handles.remove(I.activeVertex),this.handles.remove(St)}_createOrUpdateGraphic(t){if(this._graphic!=null)return this._updateGraphicGeometry(this._graphic,t),this._graphic;const n=this._graphic=new Xe({...this.graphicProperties,symbol:this.graphicSymbol});return this._updateGraphicGeometry(n,t),this.internalGraphicsLayer.add(n),this.handles.add(this.initializeGraphic(n)),this.notifyChange("graphic"),this.handles.add(Be(()=>{this.internalGraphicsLayer.remove(n),D(n),this._graphic===n&&(this._graphic=null)}),St),n}_updateGraphicGeometry(t,n){t.geometry=n}_getCreateOperationGeometry(t={operationComplete:!1}){var v;const{drawOperation:n}=this;if(n==null||n.numVertices===0)return null;const{coordinateHelper:i,view:o}=n,a=n.stagedVertex,s=n.committedVertices,r=s.slice(),p=a!=null;p&&r.push(i.pointToArray(a));const d=p?i.pointToArray(a):s.splice(-1)[0],h=r.length,g=o.spatialReference,y=o.type==="3d"&&o.viewingMode==="global",u=new Dn;switch(this.geometryType){case"point":case"mesh":u.regularVertices=s,u.activeVertex=d,u.full=i.arrayToPoint(r[0]);break;case"multipoint":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=En(r,g));break;case"polyline":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=Qt([r],g,y));break;case"polygon":u.regularVertices=s,u.activeVertex=d,h>0&&(u.full=q([r],g,y,!0));break;case"circle":if(h>0){const f=Kt(o,r[0]);if(h===1&&t.operationComplete){const w=r[0],T=f.makeMapPoint(w[0]+ne*o.resolution,w[1]);u.circle=ee([w,T],f,!0),u.full=u.circle!=null?u.circle.geometry:null}else h===2&&(this.forceUniformSize?(u.circle=ee(r,f,this.centered),u.full=u.circle!=null?u.circle.geometry:null):(u.rectangle=Vn(r,f,this.centered),u.full=u.rectangle.geometry))}break;case"rectangle":if(h>0){const f=Kt(o,r[0]);if(h===1&&t.operationComplete){const w=r[0],T=f.makeMapPoint(w[0]+ne*o.resolution,w[1]);u.rectangle=te([w,T],f,!0),u.full=u.rectangle.geometry}else h===2&&(u.rectangle=this.forceUniformSize?te(r,f,this.centered):In(r,f,this.centered),u.full=u.rectangle.geometry)}break;default:return null}switch(this.geometryType){case"point":case"multipoint":break;case"polyline":u.outline=h>1?Qt([r],g,y):null;break;case"polygon":u.outline=h>1?q([r],g,y):null;break;case"circle":case"rectangle":u.outline=((v=u.full)==null?void 0:v.type)==="polygon"?q(u.full.rings,g,y):null}return u}initializeGraphic(t){return null}onComplete(t){this._updateGraphic();let n=null;if(this.drawOperation.isCompleted){const i=this._getCreateOperationGeometry({operationComplete:!0});i!=null&&(n=this._createOrUpdateGraphic(i.full).clone())}this._createOperationGeometry=null,this.emit("complete",{graphic:n,...t})}onCursorUpdate(t){this._updateGraphic(),this.emit("cursor-update",t)}onDeactivate(){this.drawOperation.isCompleted||this.drawOperation.cancel()}onVertexAdd(t){this._updateGraphic(),this.emit("vertex-add",t)}onVertexRemove(t){this._updateGraphic(),this.emit("vertex-remove",t)}onVertexUpdate(t){this._updateGraphic(),this.emit("vertex-update",t)}_updateGraphic(){const t=this._getCreateOperationGeometry();this._createOperationGeometry=t,t!=null?(t.outline!=null?this.handles.add(this.onOutlineChanged(t.outline),I.outline):this.handles.remove(I.outline),t.regularVertices!=null?this.handles.add(this.onRegularVerticesChanged(t.regularVertices),I.regularVertices):this.handles.remove(I.regularVertices),t.activeVertex!=null?this.handles.add(this.onActiveVertexChanged(t.activeVertex),I.activeVertex):this.handles.remove(I.activeVertex),t.full!=null?this._createOrUpdateGraphic(t.full):this.handles.remove(St)):this._destroyAllVisualisations()}get _tooltipInfo(){const{drawOperation:t}=this;if(!t)return null;switch(this.geometryType){case"point":return this._drawPointTooltipInfo;case"polyline":return this._drawPolylineTooltipInfo;case"polygon":return this._drawPolygonTooltipInfo;case"rectangle":return this._drawRectangleTooltipInfo;case"circle":return this._drawCircleTooltipInfo;case"mesh":return this._drawMeshTooltipInfo;default:return null}}get _drawPointTooltipInfo(){const{view:t,graphic:n}=this,i=n==null?void 0:n.geometry;return(i==null?void 0:i.type)!=="point"||t.type==="2d"&&this.defaultZ===0?null:new A({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:t.type,helpMessage:ct("point",i,t)})}get _drawPolylineTooltipInfo(){const t=this._createOperationGeometry,n=t!=null?t.full:null;if((n==null?void 0:n.type)!=="polyline")return null;const i=un(n,this._elevationMode),{view:o}=this;return new R({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,totalLength:i??V,viewType:o.type,helpMessage:ct("polyline",n,o)})}get _drawPolygonTooltipInfo(){const t=this._createOperationGeometry,n=t!=null?t.full:null;if((n==null?void 0:n.type)!=="polygon")return null;const i=Jt(n,this._elevationMode),{view:o}=this;return new z({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,area:i??J,viewType:o.type,helpMessage:ct("polygon",n,o)})}get _drawMeshTooltipInfo(){const{view:t,graphic:n}=this,i=n==null?void 0:n.geometry;return(i==null?void 0:i.type)!=="mesh"||t.type==="2d"&&this.defaultZ===0?null:new k({tooltipOptions:this.tooltipOptions,elevation:this._elevationTooltipDetail,viewType:t.type,helpMessage:ct("mesh",i,t)})}get _drawRectangleTooltipInfo(){return this.drawOperation==null?null:new H({tooltipOptions:this.tooltipOptions,xSize:this._xSize??V,ySize:this._ySize??V,area:this._fullGeometryArea??J})}get _drawCircleTooltipInfo(){if(this.drawOperation==null)return null;const t=this.forceUniformSize;return new G({tooltipOptions:this.tooltipOptions,radius:t?this._circleRadius??V:null,xSize:t?null:this._xSize??V,ySize:t?null:this._ySize??V,area:this._fullGeometryArea??J})}get _circleRadius(){const t=this._createOperationGeometry;return t!=null&&t.circle!=null&&t.circle.center!=null&&t.circle.edge!=null?Tt(t.circle.center,t.circle.edge,this._elevationMode):null}get _xSize(){const t=this._createOperationGeometry;if((t==null?void 0:t.rectangle)==null)return null;const{midpoints:n}=t.rectangle;return n!=null?Tt(n.left,n.right,this._elevationMode):null}get _ySize(){const t=this._createOperationGeometry;if((t==null?void 0:t.rectangle)==null)return null;const{midpoints:n}=t.rectangle;return n!=null?Tt(n.top,n.bottom,this._elevationMode):null}get _fullGeometryArea(){const t=this._createOperationGeometry,n=t!=null?t.full:null;return(n==null?void 0:n.type)!=="polygon"?null:Jt(n,this._elevationMode)}get _elevationTooltipDetail(){return{mode:this.drawOperation.elevationInfo.mode,...this._vertexTooltipElevation}}get _vertexTooltipElevation(){const{tooltipOptions:t,view:n,drawOperation:i}=this;if(i==null)return this._defaultElevation;const o=i.stagedVertex??i.lastVertex;if(o==null||n.type==="2d")return this._defaultElevation;const a={mode:t.elevation.mode,offset:0},s=(Dt(n,o,i.elevationInfo,a)??0)*Je(o.spatialReference);return Xt(s,"meters")}get _elevationMode(){return this.drawOperation.isDraped?"on-the-ground":"absolute-height"}};l([c()],m.prototype,"_createOperationGeometry",void 0),l([c()],m.prototype,"_defaultElevation",null),l([c({value:!0})],m.prototype,"centered",null),l([c({nonNullable:!0})],m.prototype,"defaultZ",void 0),l([c()],m.prototype,"drawOperation",void 0),l([c({value:!0})],m.prototype,"enabled",null),l([c({value:!0})],m.prototype,"forceUniformSize",null),l([c({constructOnly:!0})],m.prototype,"geometryType",void 0),l([c()],m.prototype,"graphic",null),l([c({constructOnly:!0})],m.prototype,"graphicProperties",void 0),l([c()],m.prototype,"graphicSymbol",null),l([c({constructOnly:!0})],m.prototype,"hasZ",void 0),l([c({constructOnly:!0,type:yt})],m.prototype,"labelOptions",void 0),l([c({constructOnly:!0})],m.prototype,"geometryToPlace",void 0),l([c({constructOnly:!0})],m.prototype,"mode",void 0),l([c()],m.prototype,"snappingManager",void 0),l([c()],m.prototype,"snapToScene",void 0),l([c()],m.prototype,"tooltip",void 0),l([c({constructOnly:!0,type:mt})],m.prototype,"tooltipOptions",void 0),l([c({readOnly:!0})],m.prototype,"type",void 0),l([c({readOnly:!0})],m.prototype,"updating",null),l([c({constructOnly:!0,nonNullable:!0})],m.prototype,"view",void 0),l([c()],m.prototype,"_tooltipInfo",null),l([c()],m.prototype,"_drawPointTooltipInfo",null),l([c()],m.prototype,"_drawPolylineTooltipInfo",null),l([c()],m.prototype,"_drawPolygonTooltipInfo",null),l([c()],m.prototype,"_drawMeshTooltipInfo",null),l([c()],m.prototype,"_drawRectangleTooltipInfo",null),l([c()],m.prototype,"_drawCircleTooltipInfo",null),l([c()],m.prototype,"_circleRadius",null),l([c()],m.prototype,"_xSize",null),l([c()],m.prototype,"_ySize",null),l([c()],m.prototype,"_fullGeometryArea",null),l([c()],m.prototype,"_elevationTooltipDetail",null),l([c()],m.prototype,"_vertexTooltipElevation",null),l([c()],m.prototype,"_elevationMode",null),m=l([E("esri.views.draw.DrawGraphicTool")],m);const St="create-operation-graphic",I={outline:"outline-visual",regularVertices:"regular-vertices-visual",activeVertex:"active-vertex-visual"};function _i(e){switch(e){case"point":case"polyline":case"polygon":case"multipoint":return e;case"circle":case"rectangle":return"segment";case"mesh":return"point"}}const ne=48,we="click";class Fn{constructor({grabbableForEvent:t}){this.events=new Gt,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0,this.grabbableForEvent=t}intersectionDistance(t,n){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}}function Zn(e,t){let n=null,i=null;return o=>{if(o.action==="cancel")return void(i!=null&&(i.execute({action:"cancel"}),n=null,i=null));const a={action:o.action,screenStart:o.start,screenEnd:o.screenPoint};o.action==="start"&&n==null&&(n=new Ct,i=new Ct,t(e,n,i,o.pointerType,a)),n!=null&&n.execute(a),o.action==="end"&&n!=null&&(n=null,i=null)}}function Mt(e,t){return e.events.on("drag",Zn(e,t))}function xi(e,t){const n=[e.x,e.y,e.z??0],i=t,o=[Math.cos(i),Math.sin(i)],a=Math.sqrt(o[0]*o[0]+o[1]*o[1]);if(a===0)return null;o[0]/=a,o[1]/=a;const s=r=>{const p=(r.x-n[0])*o[0]+(r.y-n[1])*o[1];r.x=n[0]+p*o[0],r.y=n[1]+p*o[1]};return r=>(s(r.mapStart),s(r.mapEnd),{...r,axis:o})}function An(e,t){let n=null;return i=>{if(i.action==="start"&&(n=kn(e,i.mapStart.spatialReference,t)),n==null)return null;const o=i.mapEnd.x-i.mapStart.x,a=i.mapEnd.y-i.mapStart.y,s=i.mapEnd.z-i.mapStart.z;return n.move(o,a,s,i.action),{...i,translationX:o,translationY:a,translationZ:s}}}function be(e,t){return e==null?null:e.spatialReference.equals(t)?e.clone():ft(e,t)}function kn(e,t,n){const i=e.geometry,o=Mn(t);if(i==null)return null;if(i.type==="mesh")return Hn(e,i,o,n);const a=be(i,o),s=i.spatialReference;return a==null?null:{move:(r,p,d)=>{const h=ve(a.clone(),r,p,d);h.spatialReference.equals(s)?e.geometry=h:e.geometry=ft(h,s)}}}function Hn(e,t,n,i){if(t.vertexSpace.isRelative)return Un(e,t,t.vertexSpace,n);if(!t.spatialReference.equals(n))return null;let o=0,a=0,s=0;return{move:(r,p,d)=>{const h=r-o,g=p-a,y=d-s;if(h||g||y){const u=new K(t.origin.x+h,t.origin.y+g,(t.origin.z??0)+y,t.origin.spatialReference);t.centerAt(u,{geographic:t.vertexSpace.isRelative?void 0:i===ce.Global}),e.notifyGeometryChanged(),o=r,a=p,s=d}}}}function Un(e,t,n,i){const o=be(n.getOriginPoint(t.spatialReference),i),a=t.spatialReference;return o==null?null:{move:(s,r,p,d)=>{const h=ve(o.clone(),s,r,p);if(h.spatialReference.equals(a))n.setOriginFormPoint(h);else{const g=ft(h,a);g!=null&&n.setOriginFormPoint(g)}if(n.isGeoreferenced)e.notifyGeometryChanged();else{const g=d==="end";e.notifyMeshTransformChanged(g?{action:On.UpdateFastLocalOrigin}:{})}}}}function wi(e,t=null,n){var s;let i=null;const o=t==null||(s=e.spatialReference)!=null&&s.equals(t)?r=>r:r=>r!=null?ft(r,t):r,a={exclude:[],...n};return r=>{if(r.action==="start"&&(i=o(e.toMap(r.screenStart,a))),i==null)return null;const p=o(e.toMap(r.screenEnd,a));return p!=null?{...r,mapStart:i,mapEnd:p}:null}}function bi(e,t){const n=e.map(i=>An(i,t)).filter(at);return i=>{const o=i.mapEnd.x-i.mapStart.x,a=i.mapEnd.y-i.mapStart.y,s=i.mapEnd.z-i.mapStart.z;return n.forEach(r=>r(i)),{...i,translationX:o,translationY:a,translationZ:s}}}function Wn(e,t){const n=new Map;for(const i of t)n.set(i,zt(e[i]));return i=>(n.forEach((o,a)=>{e[a]=o}),i)}function Ln(e){return e.geometry!=null&&e.geometry.type==="mesh"?Nn(e,e.geometry):Wn(e,["geometry"])}function Nn(e,t){var a;const{vertexSpace:n}=t;if(n.isGeoreferenced){const s=t.vertexAttributes.clonePositional();return r=>(t.vertexAttributes=s,e.notifyGeometryChanged(),r)}const i=Ke(n.origin),o=(a=t.transform)==null?void 0:a.clone();return s=>(t.transform=o,t.vertexSpace.origin=i,e.notifyMeshTransformChanged(),s)}function Ti(e){const t=e.map(n=>Ln(n)).filter(n=>n!=null);return n=>(t.forEach(i=>i(n)),n)}function Si(){let e=0,t=0,n=0;return i=>{i.action==="start"&&(e=i.mapStart.x,t=i.mapStart.y,n=i.mapStart.z);const o=i.mapEnd.x-e,a=i.mapEnd.y-t,s=i.mapEnd.z-n;return e=i.mapEnd.x,t=i.mapEnd.y,n=i.mapEnd.z,{...i,mapDeltaX:o,mapDeltaY:a,mapDeltaZ:s,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function Mi(){let e=0,t=0;return n=>{n.action==="start"&&(e=n.screenStart.x,t=n.screenStart.y);const i=n.screenEnd.x-e,o=n.screenEnd.y-t;return e=n.screenEnd.x,t=n.screenEnd.y,{...n,screenDeltaX:i,screenDeltaY:o}}}function Oi(e,t){let n=null,i=0,o=0;return a=>{var d;if(a.action==="start"&&(n=(d=e.toScreen)==null?void 0:d.call(e,t),n!=null&&(n.x<0||n.x>e.width||n.y<0||n.y>e.height?n=null:(i=a.screenStart.x-n.x,o=a.screenStart.y-n.y))),n==null)return null;const s=Ht(a.screenEnd.x-i,0,e.width),r=Ht(a.screenEnd.y-o,0,e.height),p=he(s,r);return a.screenStart=n,a.screenEnd=p,a}}const qn=()=>{};let Ct=class Te{constructor(){this.execute=qn}next(t,n=new Te){return t!=null&&(this.execute=i=>{const o=t(i);o!=null&&n.execute(o)}),n}};function jn(e,t,n=[]){if(e.type==="2d")return o=>o;let i=null;return o=>{o.action==="start"&&(i=e.toMap(o.screenStart,{exclude:n}),i!=null&&(i.z=dt(i,e,t)));const a=e.toMap(o.screenEnd,{exclude:n});a!=null&&(a.z=dt(a,e,t));const s=i!=null&&a!=null?{sceneStart:i,sceneEnd:a}:null;return{...o,scenePoints:s}}}function ie(e,t,n){const i=t.elevationProvider.getElevation(e.x,e.y,e.z??0,e.spatialReference,"scene")??0,o=vt(e);return o.z=i,o.hasZ=!0,o.z=dt(o,t,n),o}function $i(e,t){if(e.type==="2d")return i=>i;let n=null;return i=>{i.action==="start"&&(n=ie(i.mapStart,e,t));const o=ie(i.mapEnd,e,t),a=n!=null&&o!=null?{sceneStart:n,sceneEnd:o}:null;return{...i,scenePoints:a}}}function Yn({predicate:e=()=>!0,snappingManager:t,snappingContext:n,updatingHandles:i,useZ:o=!0}){const a=new Ct;if(t==null)return{snappingStep:[oe,a],cancelSnapping:oe};let s,r=null,p=null,d=null;const h=()=>{r=Pt(r),t.doneSnapping(),p!=null&&p.frameTask.remove(),p=null,s=ge(s),d=null},g=Xn(t,o,a);let y=null,u=null,v=null;return{snappingStep:[f=>{if(!e(f))return f;const{action:w}=f;if(w==="start"){const{info:T}=f,S=Bn(t.view);if(p=Jn(n,f,S),p.context.selfSnappingZ=null,!o&&T!=null){const C=Qn(n.coordinateHelper,T.handle.component);C!=null&&(p.context.selfSnappingZ={value:C,elevationInfo:n.elevationInfo??Qe})}}if(p!=null){const{context:T,originalScenePos:S,originalPos:C}=p,{mapEnd:tt,mapStart:et,scenePoints:P}=f,nt=Se(C,Rt(tt,et)),rt=Rt(et,C),$e={...f,action:"update"},Pe=p.context,_t=Kn(S,P),Ft=t.update({point:nt,scenePoint:_t,context:T});if(v=Ft,Me(tt,Ft,rt,o),y=nt,u=_t,w!=="end"){const{frameTask:Ee}=p;r==null&&(r=new AbortController),d=Ie=>{i.addPromise(Et(g({frameTask:Ee,event:$e,context:Pe,point:nt,scenePoint:_t,delta:rt,getLastState:()=>({point:y,scenePoint:u,updatePoint:Ie.forceUpdate?null:v})},r.signal)))},d({forceUpdate:!1}),s==null&&(s=L(()=>t.options.effectiveEnabled,()=>d==null?void 0:d({forceUpdate:!0})))}}return w==="end"&&h(),f},a],cancelSnapping:f=>(h(),f)}}function Xn(e,t,n){return ye(async({frameTask:i,point:o,scenePoint:a,context:s,event:r,delta:p,getLastState:d},h)=>{const g=await i.schedule(()=>e.snap({point:o,scenePoint:a,context:s,signal:h}),h);if(g.valid){let y=await i.schedule(()=>g.apply(),h);const u=d();u.point!=null&&o!==u.point&&(y=e.update({point:u.point,scenePoint:u.scenePoint,context:s})),u.updatePoint!=null&&Vt(y,u.updatePoint)||(Me(r.mapEnd,y,p,t),n.execute(r))}})}function Bn(e){return e.type==="3d"?e.resourceController.scheduler.registerTask(ue.SNAPPING):de}function Jn(e,t,n){return{context:new It({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:t.info!=null?t.info.handle:null,excludeFeature:e.excludeFeature,visualizer:e.visualizer}),originalPos:t.snapOrigin!=null?e.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:t.scenePoints!=null?t.scenePoints.sceneStart:null,frameTask:n}}function Se(e,[t,n,i]){const o=vt(e);return o.x+=t,o.y+=n,o.hasZ&&(o.z+=i),o}function Kn(e,t){return e==null||t==null?null:Se(e,Rt(t.sceneEnd,t.sceneStart))}function Rt(e,t){const n=e.hasZ&&t.hasZ?e.z-t.z:0;return[e.x-t.x,e.y-t.y,n]}function Me(e,t,[n,i,o],a){e.x=t.x+n,e.y=t.y+i,a&&e.hasZ&&t.hasZ&&(e.z=t.z+o)}function Qn(e,t){if(!e.hasZ())return null;const n=t.vertices;let i=null;for(const o of n){const a=e.getZ(o.pos);if(i!=null&&a!=null&&Math.abs(a-i)>1e-6)return null;i==null&&(i=a)}return i}function oe(e){return e}let U=class extends pe{constructor(e){super(e),this.constrainResult=t=>t,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=ye(async(t,n,i,o)=>{const a=this._frameTask;if(a==null)return;const s=await a.schedule(()=>n.snap({...t,context:i,signal:o}),o);s.valid&&await a.schedule(()=>{this.stagedPoint=s.apply(),t!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},o)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(e){this._stagedPoint=this.constrainResult(e)}initialize(){var t,n;const e=this.view.type==="3d"?(n=(t=this.view)==null?void 0:t.resourceController)==null?void 0:n.scheduler:null;this._frameTask=e!=null?e.registerTask(ue.SNAPPING):de}destroy(){this._abortController=Pt(this._abortController),this._frameTask=ge(this._frameTask)}update(e,t,n){this._snapPoints=e;const{point:i,scenePoint:o}=e,a=t.update({point:i,scenePoint:o,context:n});return this.stagedPoint=a,a}async snap(e,t,n){const{point:i,scenePoint:o}=e;return this.stagedPoint=t.update({point:i,scenePoint:o,context:n}),this._snapPoints=e,this._abortController==null&&(this._abortController=new AbortController),this._snap(e,t,n,this._abortController.signal)}async resnap(e,t){this._snapPoints!=null&&await this.snap(this._snapPoints,e,t)}abort(){this._abortController=Pt(this._abortController),this._snapPoints=null}};l([c({constructOnly:!0})],U.prototype,"view",void 0),l([c()],U.prototype,"stagedPoint",null),l([c()],U.prototype,"constrainResult",void 0),l([c()],U.prototype,"_stagedPoint",void 0),U=l([E("esri.views.interactive.snapping.SnappingOperation")],U);let x=class extends Gt.EventedMixin(tn){constructor(e){super(e),this._createOperationCompleted=!1,this._pointerDownStates=new Set,this._stagedScreenPoint=null,this._stagedPointerType=null,this.isDraped=!0,this.labelOptions=new yt,this.tooltipOptions=new mt,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.lastVertex=null,e.elevationInfo==null&&(this.elevationInfo=en(!!e.hasZ))}initialize(){const{geometryType:e,view:t}=this,n=t.spatialReference,i="viewingMode"in t.state?t.state.viewingMode:ce.Local,o=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=fn(this.hasZ,this.hasM,n),this._editGeometryOperations=new vn(new _n(o,this.coordinateHelper)),this._snappingOperation=new U({view:t,constrainResult:r=>{var p;return r==null?r:(p=this._getEffectiveDrawSurface())==null?void 0:p.constrainZ(r)}}),this.addHandles([L(()=>this.stagedVertex,r=>{r!=null&&this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"})},{sync:!0,equals:(r,p)=>an(r,p,Vt)}),L(()=>this.view.viewpoint,(r,p)=>{r&&p&&rn(r,p)&&this._onViewpointChange()})]),this._activeComponent=new xn(n,i),this._editGeometryOperations.data.components.push(this._activeComponent);const a=this.segmentLabels;a!=null&&(a.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions},this.addHandles([L(()=>this.labelOptions.enabled,r=>{a.visible=r},ut),this.on("cursor-update",()=>{const r=this.stagedVertex;a.stagedVertex=r!=null?this.coordinateHelper.pointToVector(r):null})])),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],r=>{const p=r.vertices.map(y=>({componentIndex:0,vertexIndex:y.index,coordinates:this.coordinateHelper.vectorToArray(y.pos)})),d=p.map(y=>y.coordinates);switch(r.type){case"vertex-add":this.emit(r.type,{...r,added:d,vertices:p});break;case"vertex-update":this.emit(r.type,{...r,updated:d,vertices:p});break;case"vertex-remove":this.emit(r.type,{...r,removed:d,vertices:p})}const h=this._activeComponent.getLastVertex(),g=h!=null?this.coordinateHelper.vectorToDehydratedPoint(h.pos):null;g!=null&&this.lastVertex!=null&&Vt(this.lastVertex,g)||(this.lastVertex=g)}));const s=this._manipulator=new Fn({grabbableForEvent:r=>this.drawingMode!=="click"||r.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(s),s.grabbable=e!=="point",this.addHandles([this._createManipulatorDragPipeline(s),s.events.on("immediate-click",r=>this._onImmediateClick(r)),s.events.on("immediate-double-click",r=>this._onImmediateDoubleClick(r)),L(()=>({cursor:this.cursor,loading:this.loading}),({cursor:r,loading:p})=>{s.cursor=p?"progress":r},ut)]),nn(this,()=>{const r=this.view.inputManager.latestPointerType??"mouse",p=this._getSnappingContext(r);this.snappingManager!=null&&this.updatingHandles.addPromise(Et(this._snappingOperation.resnap(this.snappingManager,p)))})}destroy(){D(this.segmentLabels),D(this._snappingOperation),this._editGeometryOperations=D(this._editGeometryOperations)}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._getEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activeComponent.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}set drawingMode(e){this._set("drawingMode",e??we)}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activeComponent.vertices.length}get numVertices(){return this.stagedVertex!=null?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get stagedVertex(){return this._snappingOperation.stagedPoint}set stagedVertex(e){this._snappingOperation.stagedPoint=zt(e)}get updating(){return this.updatingHandles.updating}get vertices(){const e=this.committedVertices;return this.stagedVertex!=null&&e.push(this.coordinateHelper.pointToArray(this.stagedVertex)),e}cancel(){this.complete({aborted:!0})}commitStagedVertex(){if(this._snappingOperation.abort(),this.stagedVertex!=null){const{stagedVertex:e}=this;this.stagedVertex=null,this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e))}}complete(e){const t=e&&e.aborted||!1;this._snappingOperation.abort(),this.snappingManager!=null&&this.snappingManager.doneSnapping(),this.geometryType==="segment"||this.geometryType==="point"?this.commitStagedVertex():this.stagedVertex=null;const n=this.geometryType==="multipoint"&&this.numVertices===0||this.geometryType==="polyline"&&this.numVertices<2||this.geometryType==="polygon"&&this.numVertices<3;this._createOperationCompleted=!n,(this.isCompleted||t)&&this.emit("complete",{vertices:this.vertices.map((i,o)=>({componentIndex:0,vertexIndex:o,coordinates:i})),aborted:t,type:"complete"})}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_closeOnClickVertexIndex(e){const t=this._activeComponent;if(this.geometryType==="polygon"&&t.vertices.length>2){if(this._vertexWithinPointerDistance(t.vertices[0].pos,e))return 0;if(this._vertexWithinPointerDistance(t.vertices[t.vertices.length-1].pos,e))return t.vertices.length-1}return null}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return Mt(e,(t,n,i,o)=>{const a=o==="touch"&&this._snappingEnabled;if(this.isCompleted||!a)return;const{snappingStep:s,cancelSnapping:r}=Yn({predicate:()=>a,snappingManager:this.snappingManager,snappingContext:new It({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:o,visualizer:this.snappingVisualizer}),updatingHandles:this.updatingHandles,useZ:!this._requiresScenePoint});i=i.next(p=>(a&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),p)).next(r),n.next(this._screenToMapDragEventStep()).next(p=>(p.action==="start"&&(this.stagedVertex=p.mapStart,(this.geometryType==="segment"||a&&this.numVertices===0)&&this.commitStagedVertex()),p)).next(jn(this.view,this.elevationInfo)).next(...s).next(p=>(a&&(this.stagedVertex=p.mapEnd,p.action==="end"&&this.commitStagedVertex()),p)).next(p=>(p.action==="end"&&(this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),p))})}_createManipulatorDragPipelineFreehand(e){return Mt(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this.stagedVertex==null&&(this.stagedVertex=i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this.stagedVertex=i.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(e){return Mt(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this.stagedVertex==null&&(this.stagedVertex=i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this.stagedVertex=i.mapEnd,this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){return(this.geometryType==="segment"||this.geometryType==="polygon")&&this.numCommittedVertices>0}_getEffectiveDrawSurface(){if(this.elevationDrawSurface==null)return this.drawSurface;if(!this.coordinateHelper.hasZ())return this.elevationDrawSurface.defaultZ=null,this.elevationDrawSurface;let e=this.defaultZ,t=!1;return this.elevationInfo!=null&&this.elevationInfo.mode==="absolute-height"&&(t=!0),this.snapToSceneEnabled!=null&&(t=this.snapToSceneEnabled),this.elevationInfo!=null&&this.elevationInfo.mode==="on-the-ground"&&(t=!1),this._drawAtFixedElevation&&(e=this.coordinateHelper.getZ(this._activeComponent.vertices[0].pos),t=!1),t?this.drawSurface:(this.elevationDrawSurface.defaultZ=e,this.elevationDrawSurface)}_mapToScreen(e){var t;return(t=this._getEffectiveDrawSurface())==null?void 0:t.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&(this.stagedVertex=e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging)return;const t=this._activeComponent;if(this._closeOnClickVertexIndex(e.screenPoint)!=null)return e.stopPropagation(),void this.complete();const n=this._screenToMap(e.screenPoint);if(n!=null)switch(this.drawingMode){case"freehand":this.geometryType==="point"&&(this.stagedVertex!=null?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),this.complete());break;case"click":case"hybrid":this._snappingOperation.abort(),this.stagedVertex!=null?this.commitStagedVertex():this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(n)),(this.geometryType==="point"||this.geometryType==="segment"&&t.vertices.length===2||this.geometryType==="segment"&&this.drawingMode==="hybrid"&&t.vertices.length===1)&&this.complete()}e.stopPropagation()}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=he(e.x,e.y);this._stagedScreenPoint=t,this._stagedPointerType=e.pointerType;const n=this._snappingOperation,i=this._manipulator;i.dragging||this._pointerDownStates.has(e.pointerId)||i.grabbing||!i.interactive?n.abort():(e.stopPropagation(),this._updateStagedVertexOnPointerMove(t,e.pointerType))}_onViewpointChange(){const e=this._manipulator;this._stagedScreenPoint&&!e.dragging&&!e.grabbing&&e.interactive?this._updateStagedVertexOnPointerMove(this._stagedScreenPoint,this._stagedPointerType??"mouse"):this._snappingOperation.abort()}_updateStagedVertexOnPointerMove(e,t){var p;const n=this._snappingOperation,i=this._closeOnClickVertexIndex(e);if(i!=null)return this._closeOnVertex(i),void n.abort();const o=this._screenToMap(e),a=this._requiresScenePoint?(p=this.drawSurface)==null?void 0:p.screenToMap(e):null;if(o==null)return this.cursor=null,void n.abort();this.cursor="crosshair";const s=this.snappingManager;if(s==null)return this.stagedVertex=o,void n.abort();const r=this._getSnappingContext(t);this.updatingHandles.addPromise(Et(n.snap({point:o,scenePoint:a},s,r)))}_closeOnVertex(e){this.stagedVertex=null;const t={componentIndex:0,vertexIndex:e,coordinates:this.coordinateHelper.vectorToArray(this._activeComponent.vertices[e].pos)};this.emit("cursor-update",{updated:null,vertices:[t],operation:"apply",type:"vertex-update"})}_screenToMap(e){var t;return(t=this._getEffectiveDrawSurface())==null?void 0:t.screenToMap(e)}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const n=this._screenToMap(t.screenEnd);return n!=null?{...t,mapStart:e,mapEnd:n}:null}}_vertexWithinPointerDistance(e,t){const i=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return i!=null&&ti(i,t,25)}_getSnappingContext(e){const t=this._drawAtFixedElevation?on(this.elevationDrawSurface,({defaultZ:n})=>n):null;return new It({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null})}};function ti(e,t,n){const i=e.x-t.x,o=e.y-t.y;return i*i+o*o<=n}l([c()],x.prototype,"_snappingEnabled",null),l([c()],x.prototype,"defaultZ",void 0),l([c()],x.prototype,"isDraped",void 0),l([c({value:we})],x.prototype,"drawingMode",null),l([c({constructOnly:!0})],x.prototype,"elevationDrawSurface",void 0),l([c({constructOnly:!0})],x.prototype,"elevationInfo",void 0),l([c({constructOnly:!0,type:yt})],x.prototype,"labelOptions",void 0),l([c({constructOnly:!0,type:mt})],x.prototype,"tooltipOptions",void 0),l([c({constructOnly:!0})],x.prototype,"geometryType",void 0),l([c({constructOnly:!0})],x.prototype,"hasM",void 0),l([c({constructOnly:!0})],x.prototype,"hasZ",void 0),l([c()],x.prototype,"cursor",void 0),l([c()],x.prototype,"loading",void 0),l([c({constructOnly:!0})],x.prototype,"manipulators",void 0),l([c({constructOnly:!0})],x.prototype,"drawSurface",void 0),l([c({constructOnly:!0})],x.prototype,"segmentLabels",void 0),l([c({constructOnly:!0})],x.prototype,"snappingManager",void 0),l([c({constructOnly:!0})],x.prototype,"snappingVisualizer",void 0),l([c()],x.prototype,"snapToSceneEnabled",void 0),l([c()],x.prototype,"_snappingOperation",void 0),l([c()],x.prototype,"stagedVertex",null),l([c()],x.prototype,"lastVertex",void 0),l([c()],x.prototype,"updating",null),l([c({constructOnly:!0})],x.prototype,"view",void 0),x=l([E("esri.views.draw.DrawOperation")],x);class Pi{constructor(t,n,i,o=null){this._elevationInfo=t,this.defaultZ=n,this._view=i,this._excludeGraphics=o}screenToMap(t){if(this.defaultZ!=null)return this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ut(t.x,t.y),this._elevationInfo,this.defaultZ,this._excludeGraphics);const n=this._view.sceneIntersectionHelper.intersectElevationFromScreen(Ut(t.x,t.y),this._elevationInfo,0,this._excludeGraphics);return n!=null&&(n.z=void 0),n}mapToScreen(t){const n=me(t.x,t.y,Dt(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(n)}constrainZ(t){const{defaultZ:n}=this;return n!=null&&t.z!==n&&((t=vt(t)).z=n),t}}class Ei{constructor(t,n,i=[]){this.view=t,this.elevationInfo=n,this.exclude=i}screenToMap(t){const n=this.view.toMap(t,{exclude:this.exclude});return n!=null&&(n.z=dt(n,this.view,this.elevationInfo)),n}mapToScreen(t){let n=t;return this.elevationInfo!=null&&(n=me(t.x,t.y,Dt(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(n)}constrainZ(t){return t}}class Ii{constructor(t,n=!1,i=0){this.view=t,this.hasZ=n,this.defaultZ=i,this.mapToScreen=o=>t.toScreen(o),this.screenToMap=n?o=>{const a=t.toMap(o);return a.z=i,a}:o=>t.toMap(o)}constrainZ(t){const{defaultZ:n}=this;return this.hasZ&&t.z!==n&&((t=vt(t)).z=n),t}}function Vi(e,t){return Oe(e,t,!1)}function Ci(e,t){return Oe(e,t,!0)}function Oe(e,t,n){if(e instanceof wn){if(e.operation instanceof bn)return ei(e.operation,t,n),!0;if(e.operation instanceof Tn)return ni(e.operation,t,n),!0;if(e.operation instanceof Sn)return ii(e.operation,t,n),!0}return!1}function ei(e,t,n=!1){const i=n?-1:1,o=sn(i*e.dx,i*e.dy,i*e.dz);ot(t.origin,t.origin,o)}function ni(e,t,n=!1){const i=n?-e.angle:e.angle;Wt(t.basis1,t.basis1,Lt,i),Wt(t.basis2,t.basis2,Lt,i)}function ii(e,t,n=!1){const i=n?1/e.factor1:e.factor1,o=n?1/e.factor2:e.factor2;B(t.basis1,t.basis1,i),B(t.basis2,t.basis2,o),Nt(t.origin,t.origin,e.origin,e.axis1,i),Nt(t.origin,t.origin,e.origin,e.axis2,o)}function Ri(e,t,n,i){i||(i=fe());const o=j(it.get(),e[1],-e[0]),a=j(it.get(),Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),s=j(it.get(),Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY),r=it.get();t.components.forEach(h=>h.vertices.forEach(g=>{const y=g.pos;j(r,qt(e,y),qt(o,y)),ln(a,a,r),pn(s,s,r)}));const p=1e-6,d=j(it.get(),s[0]-a[0]<p?n/2:0,s[1]-a[1]<p?n/2:0);return cn(a,a,d),wt(s,s,d),jt(i.basis1,e,(s[0]-a[0])/2),jt(i.basis2,o,(s[1]-a[1])/2),j(i.origin,a[0]*e[0]+a[1]*o[0],a[0]*e[1]+a[1]*o[1]),wt(i.origin,i.origin,i.basis1),wt(i.origin,i.origin,i.basis2),i}function zi(e,t,n,i=0,o){o||(o=fe()),t.toRenderCoords(e.origin,n,o.origin);const a=M.get();ot(a,e.origin,e.basis1),ot(a,a,e.basis2),t.toRenderCoords(a,n,a);const s=M.get();ot(s,e.origin,e.basis1),$(s,s,e.basis2),t.toRenderCoords(s,n,s);const r=M.get();$(r,e.origin,e.basis1),$(r,r,e.basis2),t.toRenderCoords(r,n,r);const p=M.get();$(p,e.origin,e.basis1),ot(p,p,e.basis2),t.toRenderCoords(p,n,p);const d=Z(M.get(),a,s,.5);$(d,d,o.origin);const h=Z(M.get(),r,p,.5);$(h,o.origin,h),Z(o.basis1,d,h,.5);const g=Z(M.get(),p,a,.5);$(g,g,o.origin);const y=Z(M.get(),s,r,.5);$(y,o.origin,y),Z(o.basis2,g,y,.5);const u=Ot(M.get(),o.basis1,o.basis2),v=Ot(u,u,o.basis1);return re(v,v),B(o.basis2,v,ae(o.basis2,v)),B(o.basis1,o.basis1,1+i/Yt(o.basis1)),B(o.basis2,o.basis2,1+i/Yt(o.basis2)),hn(o),o}function Gi(e,t,n,i){const o=M.get();$(o,$(o,e.origin,e.basis1),e.basis2);const a=M.get();bt(a,o,e.basis1,2);const s=M.get();bt(s,a,e.basis2,2);const r=M.get();bt(r,o,e.basis2,2),o[2]=a[2]=s[2]=r[2]=t;const p=i?"on-the-ground":"absolute-height",d=Bt(st(o,a,n,p),st(r,s,n,p)),h=Bt(st(a,s,n,p),st(o,r,n,p));return h==null||d==null?null:[d,h]}export{jn as C,Oi as D,m as E,Vi as F,zi as G,_i as H,x as I,Gi as M,$i as O,Si as P,Ci as S,Ct as U,Ri as a,Ii as c,Mt as d,Yn as f,bi as j,b as l,Ei as o,Mi as q,Pi as r,wi as v,Ti as w,An as x,xi as y,Ln as z};
