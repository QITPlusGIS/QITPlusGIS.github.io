import{bA as $,i1 as z,iB as m,fo as b,y as x,S as g,iC as y}from"./index-d502c71f.js";function U(s=!1,e){if(s){const{elevationInfo:t,alignPointsInFeatures:n,spatialReference:a}=e;return new w(t,n,a)}return new I}let I=class{async alignCandidates(e,t){return e}notifyElevationSourceChange(){}};const v=1024;let w=class{constructor(e,t,n){this._elevationInfo=e,this._alignPointsInFeatures=t,this.spatialReference=n,this._alignmentsCache=new $(v),this._cacheVersion=0,this._metersPerVerticalUnit=z(n)}async alignCandidates(e,t){const n=this._elevationInfo;return n==null||n.mode!=="absolute-height"||n.featureExpressionInfo?this._alignComputedElevationCandidates(e,t):(this._alignAbsoluteElevationCandidates(e,n),e)}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignAbsoluteElevationCandidates(e,t){const{offset:n,unit:a}=t;if(n==null)return;const o=n*(m(a??"meters")/this._metersPerVerticalUnit);for(const i of e)switch(i.type){case"edge":i.start.z+=o,i.end.z+=o;continue;case"vertex":i.target.z+=o;continue}}async _alignComputedElevationCandidates(e,t){const n=new Map;for(const r of e)b(n,r.objectId,S).push(r);const[a,o,i]=this._prepareQuery(n),c=await this._alignPointsInFeatures(a,t);if(x(t),i!==this._cacheVersion)return this._alignComputedElevationCandidates(e,t);this._applyCacheAndResponse(a,c,o);const{drapedObjectIds:h,failedObjectIds:u}=c,l=[];for(const r of e){const{objectId:d}=r;h.has(d)&&r.type==="edge"&&(r.draped=!0),u.has(d)||l.push(r)}return l}_prepareQuery(e){const t=[],n=[];for(const[a,o]of e){const i=[];for(const c of o)this._addToQueriesOrCachedResult(a,c.target,i,n),c.type==="edge"&&(this._addToQueriesOrCachedResult(a,c.start,i,n),this._addToQueriesOrCachedResult(a,c.end,i,n));i.length!==0&&t.push({objectId:a,points:i})}return[t,n,this._cacheVersion]}_addToQueriesOrCachedResult(e,t,n,a){const o=_(e,t),i=this._alignmentsCache.get(o);i==null?n.push(t):a.push(new j(t,i))}_applyCacheAndResponse(e,{elevations:t,drapedObjectIds:n,failedObjectIds:a},o){for(const h of o)h.apply();let i=0;const c=this._alignmentsCache;for(const{objectId:h,points:u}of e){if(a.has(h)){i+=u.length;continue}const l=!n.has(h);for(const r of u){const d=_(h,r),f=t[i++];r.z=f,l&&c.put(d,f,1)}}}};class j{constructor(e,t){this.point=e,this.z=t}apply(){this.point.z=this.z}}function _(s,{x:e,y:t,z:n}){return`${s}-${e}-${t}-${n??0}}`}function S(){return[]}class V{filter(e,t){return t}notifyElevationSourceChange(){}}let E=class{filter(e,t){const{point:n,distance:a}=e,{z:o}=n;if(o==null||t.length===0)return t;const i=A(a),c=this._updateCandidatesTo3D(t,n,i).filter(O);return c.sort(M),c}_updateCandidatesTo3D(e,t,n){for(const a of e)switch(a.type){case"edge":R(a,t,n);continue;case"vertex":Q(a,t,n);continue}return e}};function O(s){return s.distance<=1}function H(s=!1){return s?new E:new V}function R(s,e,{x:t,y:n,z:a}){const{start:o,end:i,target:c}=s;s.draped||T(c,e,o,i);const h=(e.x-c.x)/t,u=(e.y-c.y)/n,l=(e.z-c.z)/a;s.distance=Math.sqrt(h*h+u*u+l*l)}function T(s,e,t,n){const a=n.x-t.x,o=n.y-t.y,i=n.z-t.z,c=a*a+o*o+i*i,h=(e.x-t.x)*a+(e.y-t.y)*o+i*(e.z-t.z),u=Math.min(1,Math.max(0,h/c)),l=t.x+a*u,r=t.y+o*u,d=t.z+i*u;s.x=l,s.y=r,s.z=d}function Q(s,e,{x:t,y:n,z:a}){const{target:o}=s,i=(e.x-o.x)/t,c=(e.y-o.y)/n,h=(e.z-o.z)/a,u=Math.sqrt(i*i+c*c+h*h);s.distance=u}function A(s){return typeof s=="number"?{x:s,y:s,z:s}:s}function M(s,e){return s.distance-e.distance}function J(s=!1,e){return s?new q(e):new P}class P{async fetch(){return[]}notifySymbologyChange(){}}const F=1024;class q{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new $(F),this._cacheVersion=0}async fetch(e,t){if(e.length===0)return[];const n=[],a=[],o=this._candidatesCache;for(const r of e){const d=C(r),f=o.get(d);if(f)for(const p of f)a.push(g(p));else n.push(r),o.put(d,[],1)}if(n.length===0)return a;const i=this._cacheVersion,{candidates:c,sourceCandidateIndices:h}=await this._getSymbologyCandidates(n,t);if(x(t),i!==this._cacheVersion)return this.fetch(e,t);const u=[],{length:l}=c;for(let r=0;r<l;++r){const d=c[r],f=C(n[h[r]]),p=o.get(f);p.push(d),o.put(f,p,p.length),u.push(g(d))}return a.concat(u)}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function C(s){switch(s.type){case"vertex":{const{objectId:e,target:t}=s,n=`${e}-vertex-${t.x}-${t.y}-${t.z??0}`;return y(n).toString()}case"edge":{const{objectId:e,start:t,end:n}=s,a=`${e}-edge-${t.x}-${t.y}-${t.z??0}-to-${n.x}-${n.y}-${n.z??0}`;return y(a).toString()}default:return""}}export{U as i,J as n,H as r};
